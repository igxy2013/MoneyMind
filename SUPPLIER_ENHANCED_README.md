# 供应商管理增强功能

## 🎯 功能概述

本次更新为供应商管理系统增加了以下增强功能：

### 1. 供应商类型分离
- **供应方式**：产地直供/合作社、本地批发市场供应商、一件代发供应商、社区本地农户/小农场
- **重要程度**：核心供应商、备用供应商、临时供应商

### 2. 供货品类实时同步
- 供货品类数据来源于商品管理中的商品名称
- 支持动态添加和删除品类
- 实时从商品管理获取最新商品列表

### 3. 多张图片支持
- 支持上传多张供应商场地照片
- 图片预览功能
- 单张图片删除功能
- 自动生成唯一文件名

## 📁 文件结构

### 新增文件
- `migrate_supplier_enhanced.py` - 数据库迁移脚本
- `test_supplier_enhanced.py` - 功能测试脚本
- `start_enhanced_supplier.bat` - 启动脚本
- `SUPPLIER_ENHANCED_README.md` - 本文档

### 修改文件
- `app.py` - 添加新数据模型和API路由
- `templates/suppliers.html` - 更新供应商列表显示
- `templates/add_supplier.html` - 更新添加供应商表单
- `templates/edit_supplier.html` - 更新编辑供应商表单

## 🗄️ 数据库变更

### 新增表
1. **supplier_images** - 供应商图片表
   - id: 主键
   - supplier_id: 供应商ID（外键）
   - image_path: 图片路径
   - upload_time: 上传时间

2. **supplier_supply_categories** - 供应商供货品类关联表
   - id: 主键
   - supplier_id: 供应商ID（外键）
   - product_name: 商品名称
   - created_at: 创建时间

### 新增字段
- **supplier.supply_method** - 供应方式
- **supplier.importance_level** - 重要程度

## 🚀 使用方法

### 1. 运行迁移脚本
```bash
python migrate_supplier_enhanced.py
```

### 2. 测试功能
```bash
python test_supplier_enhanced.py
```

### 3. 启动应用
```bash
python app.py
```

### 4. 使用新功能

#### 添加供应商
1. 访问供应商管理页面
2. 点击"添加供应商"
3. 选择供应方式和重要程度
4. 从商品管理中选择供货品类
5. 上传多张场地照片
6. 保存供应商信息

#### 编辑供应商
1. 在供应商列表中点击"编辑"
2. 修改供应方式和重要程度
3. 添加或删除供货品类
4. 上传新图片或删除现有图片
5. 保存修改

## 🔧 API接口

### 获取商品列表
```
GET /api/products
```
返回所有活跃商品的名称列表

### 获取供应商图片
```
GET /api/supplier/<id>/images
```
返回指定供应商的所有图片信息

### 上传供应商图片
```
POST /api/supplier/<id>/images
```
上传新图片到指定供应商

### 删除供应商图片
```
DELETE /api/supplier/<supplier_id>/images/<image_id>
```
删除指定的供应商图片

## 🎨 界面特性

### 供应商列表页面
- 显示供应方式和重要程度标签
- 显示供货品类徽章
- 显示图片数量提示

### 添加/编辑页面
- 分离的供应方式和重要程度选择
- 动态的供货品类选择框
- 多图片上传和预览
- 实时商品列表加载

## 🔒 安全特性

- 文件上传类型验证
- 文件大小限制（16MB）
- 唯一文件名生成
- 登录验证和权限控制

## 📝 注意事项

1. 确保商品管理中有商品数据，否则供货品类选择为空
2. 图片文件会保存在 `static/uploads/suppliers/` 目录
3. 删除供应商时会自动删除相关的图片文件
4. 供货品类会实时同步商品管理中的商品名称

## 🐛 故障排除

### 常见问题

1. **图片上传失败**
   - 检查文件格式是否支持
   - 检查文件大小是否超过16MB
   - 检查上传目录权限

2. **商品列表加载失败**
   - 确保商品管理中有商品数据
   - 检查网络连接
   - 查看浏览器控制台错误信息

3. **数据库迁移失败**
   - 检查数据库连接配置
   - 确保数据库用户有足够权限
   - 查看错误日志

## 📞 技术支持

如有问题，请检查：
1. 数据库连接是否正常
2. 文件权限是否正确
3. 浏览器控制台是否有错误信息
4. 应用日志是否有错误记录
