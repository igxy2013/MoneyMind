{% extends "base.html" %}

{% block title %}财务分析 - 七彩果坊经营管理系统{% endblock %}


{% block content %}
<div class="container mx-auto px-6 py-8 statistics-container">

<!-- 页面标题 -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">财务分析</h1>
            <p class="text-gray-600">深度分析财务数据，洞察经营状况和发展趋势</p>
        </div>
        <div class="flex items-center space-x-3">
            <button class="px-4 py-2 bg-primary text-white rounded-button text-sm whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center" onclick="exportPDFReport()">
                <i class="fas fa-file-pdf mr-2"></i>
                导出分析报告
            </button>
        </div>
    </div>
</div>

<!-- 顶部关键指标 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">总资产</span>
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wallet text-blue-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(total_assets) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if assets_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(assets_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">总负债</span>
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-file-invoice-dollar text-red-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(total_liabilities) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if liabilities_growth >= 0 %}text-red-600{% else %}text-green-600{% endif %}">{{ "{:+.2f}%".format(liabilities_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">净资产</span>
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-chart-line text-green-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(net_assets) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if net_assets_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(net_assets_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">资产负债率</span>
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                <i class="fas fa-balance-scale text-purple-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">{{ "{:.2f}%".format(liability_ratio) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if liability_ratio_change <= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(liability_ratio_change) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
</div>

<!-- 收支趋势分析 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">收支趋势分析</h3>
            <div class="flex items-center space-x-2" id="periodButtons">
                <button class="px-3 py-1 bg-primary text-white rounded-full text-sm whitespace-nowrap period-btn" data-period="monthly">月度</button>
                <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-full text-sm whitespace-nowrap period-btn" data-period="quarterly">季度</button>
                <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-full text-sm whitespace-nowrap period-btn" data-period="yearly">年度</button>
            </div>
        </div>
        <div id="trendChart" style="height: 300px;"></div>
    </div>

    <!-- 财务健康度评估 -->
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">财务健康度</h3>
        <div class="flex items-center justify-center mb-6">
            <div id="healthGauge" style="height: 200px; width: 100%;"></div>
        </div>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">偿债能力</span>
                <span class="text-sm font-medium {% if liability_ratio < 30 %}text-green-600{% elif liability_ratio < 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if liability_ratio < 30 %}优秀{% elif liability_ratio < 60 %}良好{% else %}需改善{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">盈利能力</span>
                <span class="text-sm font-medium {% if net_assets > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if net_assets > 0 %}盈利{% else %}亏损{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">营运能力</span>
                <span class="text-sm font-medium {% if health_score >= 80 %}text-green-600{% elif health_score >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if health_score >= 80 %}优秀{% elif health_score >= 60 %}良好{% else %}需改善{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">发展能力</span>
                <span class="text-sm font-medium {% if total_assets > total_liabilities %}text-green-600{% else %}text-blue-600{% endif %}">
                    {% if total_assets > total_liabilities %}稳健{% else %}谨慎{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- 收支分类统计和现金流分析 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">收支分类统计</h3>
        <div class="flex items-center">
            <div id="categoryChart" style="height: 280px; width: 60%;"></div>
            <div class="flex-1 ml-6 space-y-4">
                <div class="border-b border-gray-200 pb-4">
                    <h4 class="font-medium text-gray-900 mb-3">收入构成</h4>
                    <div class="space-y-2">
                        {% for income in income_categories %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">{{ income.name }}</span>
                            </div>
                            <span class="text-sm font-medium">¥{{ "{:,.2f}".format(income.amount) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">支出构成</h4>
                    <div class="space-y-2">
                        {% for expense in expense_categories %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">{{ expense.name }}</span>
                            </div>
                            <span class="text-sm font-medium">¥{{ "{:,.2f}".format(expense.amount) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">现金流分析</h3>
        <div id="cashflowChart" style="height: 280px;"></div>
    </div>
</div>

<!-- 月度对比分析 -->
<div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">月度对比分析</h3>
        <div class="flex items-center space-x-3">
            <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-button text-sm whitespace-nowrap hover:bg-gray-200 transition-colors flex items-center" onclick="exportData()">
                <i class="fas fa-download mr-2"></i>
                导出数据
            </button>
            <button class="px-4 py-2 bg-primary text-white rounded-button text-sm whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center" onclick="toggleCustomTime()">
                <i class="fas fa-calendar mr-2"></i>
                自定义时间
            </button>
        </div>
    </div>
    
    <!-- 自定义时间范围选择 -->
    <div id="customTimePanel" class="mb-6" style="display: none;">
        <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">自定义时间范围</h4>
            <form id="customTimeForm">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">开始日期</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" id="startDate" name="start_date" value="{{ start_date }}">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">结束日期</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" id="endDate" name="end_date" value="{{ end_date }}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
                        <div class="flex space-x-2">
                            <button type="button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" onclick="applyCustomTime()">应用</button>
                            <button type="button" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" onclick="resetToDefault()">重置</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-medium text-gray-700">月份</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">收入</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">支出</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">利润</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">环比增长</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">同比增长</th>
                </tr>
            </thead>
            <tbody>
                {% for month in monthly_data %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-4 px-4 font-medium">{{ month.date }}</td>
                    <td class="py-4 px-4 text-right text-green-600 font-medium">¥{{ "{:,.2f}".format(month.income) }}</td>
                    <td class="py-4 px-4 text-right text-red-600 font-medium">¥{{ "{:,.2f}".format(month.expense) }}</td>
                    <td class="py-4 px-4 text-right {% if month.profit < 0 %}text-red-600{% else %}text-green-600{% endif %} font-medium">
                        {{ "¥{:,.2f}".format(month.profit) if month.profit >= 0 else "-¥{:,.2f}".format(-month.profit) }}
                    </td>
                    <td class="py-4 px-4 text-right {% if month.mom_growth < 0 %}text-red-500{% else %}text-green-500{% endif %}">
                        {{ "{:+.2f}%".format(month.mom_growth) }}
                    </td>
                    <td class="py-4 px-4 text-right {% if month.yoy_growth < 0 %}text-red-500{% else %}text-green-500{% endif %}">
                        {{ "{:+.2f}%".format(month.yoy_growth) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 导出数据模态框 -->
<div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300">
        <div class="text-center">
            <div class="mb-6">
                <i class="fas fa-download text-4xl text-primary mb-4"></i>
                <h3 class="text-xl font-bold text-gray-900 mb-2">导出财务数据</h3>
                <p class="text-gray-600">请选择您需要的导出格式</p>
            </div>
            
            <!-- 导出格式选择 -->
            <div class="space-y-3 mb-6">
                <button onclick="performExport('csv')" class="w-full flex items-center justify-between p-4 border-2 border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all duration-200 group">
                    <div class="flex items-center">
                        <i class="fas fa-file-csv text-2xl text-green-600 mr-4"></i>
                        <div class="text-left">
                            <div class="font-semibold text-gray-900 group-hover:text-primary">CSV 格式</div>
                            <div class="text-sm text-gray-500">适用于Excel、数据分析工具</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-primary"></i>
                </button>
                
                <button onclick="performExport('excel')" class="w-full flex items-center justify-between p-4 border-2 border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all duration-200 group">
                    <div class="flex items-center">
                        <i class="fas fa-file-excel text-2xl text-green-700 mr-4"></i>
                        <div class="text-left">
                            <div class="font-semibold text-gray-900 group-hover:text-primary">Excel 格式</div>
                            <div class="text-sm text-gray-500">包含格式化和样式的表格</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-primary"></i>
                </button>
            </div>
            
            <!-- 加载状态 -->
            <div id="exportLoading" class="mb-6" style="display: none;">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mr-3"></div>
                    <span class="text-gray-600">正在准备下载...</span>
                </div>
            </div>
            
            <!-- 取消按钮 -->
            <button onclick="hideExportModal()" class="w-full px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                取消
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 收支趋势图
    const trendChart = echarts.init(document.getElementById('trendChart'));
    const trendOption = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(function(item) {
                    result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '<br/>';
                });
                return result;
            }
        },
        legend: {
            data: ['收入', '支出', '利润'],
            top: 10
        },
        grid: { left: 0, right: 0, top: 50, bottom: 0, containLabel: true },
        xAxis: {
            type: 'category',
            data: {{ trend_months | tojson }},
            axisLine: { lineStyle: { color: '#e5e7eb' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLine: { show: false },
            axisTick: { show: false },
            splitLine: { lineStyle: { color: '#f3f4f6' } }
        },
        series: [
            {
                name: '收入',
                type: 'line',
                smooth: true,
                data: {{ trend_income | tojson }},
                lineStyle: { color: 'rgba(87, 181, 231, 1)', width: 3 },
                itemStyle: { color: 'rgba(87, 181, 231, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(87, 181, 231, 0.1)' },
                            { offset: 1, color: 'rgba(87, 181, 231, 0.01)' }
                        ]
                    }
                }
            },
            {
                name: '支出',
                type: 'line',
                smooth: true,
                data: {{ trend_expense | tojson }},
                lineStyle: { color: 'rgba(252, 141, 98, 1)', width: 3 },
                itemStyle: { color: 'rgba(252, 141, 98, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(252, 141, 98, 0.1)' },
                            { offset: 1, color: 'rgba(252, 141, 98, 0.01)' }
                        ]
                    }
                }
            },
            {
                name: '利润',
                type: 'line',
                smooth: true,
                data: {{ trend_profit | tojson }},
                lineStyle: { color: 'rgba(141, 211, 199, 1)', width: 3 },
                itemStyle: { color: 'rgba(141, 211, 199, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(141, 211, 199, 0.1)' },
                            { offset: 1, color: 'rgba(141, 211, 199, 0.01)' }
                        ]
                    }
                }
            }
        ]
    };
    trendChart.setOption(trendOption);

    // 时间周期切换功能
    const periodButtons = document.querySelectorAll('.period-btn');
    let currentPeriod = 'monthly';
    
    // 存储不同周期的数据
    const periodData = {
        monthly: {
            months: {{ trend_months | tojson }},
            income: {{ trend_income | tojson }},
            expense: {{ trend_expense | tojson }},
            profit: {{ trend_profit | tojson }}
        },
        quarterly: {
            months: [],
            income: [],
            expense: [],
            profit: []
        },
        yearly: {
            months: [],
            income: [],
            expense: [],
            profit: []
        }
    };
    
    // 生成季度数据
    function generateQuarterlyData() {
        const monthlyData = periodData.monthly;
        const quarterlyData = { months: [], income: [], expense: [], profit: [] };
        
        for (let i = 0; i < monthlyData.months.length; i += 3) {
            const quarterMonths = monthlyData.months.slice(i, i + 3);
            if (quarterMonths.length > 0) {
                const year = quarterMonths[0].split('-')[0];
                const quarter = Math.floor(parseInt(quarterMonths[0].split('-')[1]) / 3) + 1;
                quarterlyData.months.push(`${year}Q${quarter}`);
                
                const quarterIncome = monthlyData.income.slice(i, i + 3).reduce((sum, val) => sum + val, 0);
                const quarterExpense = monthlyData.expense.slice(i, i + 3).reduce((sum, val) => sum + val, 0);
                
                quarterlyData.income.push(quarterIncome);
                quarterlyData.expense.push(quarterExpense);
                quarterlyData.profit.push(quarterIncome - quarterExpense);
            }
        }
        
        return quarterlyData;
    }
    
    // 生成年度数据
    function generateYearlyData() {
        const monthlyData = periodData.monthly;
        const yearlyData = { months: [], income: [], expense: [], profit: [] };
        const yearMap = {};
        
        monthlyData.months.forEach((month, index) => {
            const year = month.split('-')[0];
            if (!yearMap[year]) {
                yearMap[year] = { income: 0, expense: 0 };
            }
            yearMap[year].income += monthlyData.income[index];
            yearMap[year].expense += monthlyData.expense[index];
        });
        
        Object.keys(yearMap).sort().forEach(year => {
            yearlyData.months.push(year);
            yearlyData.income.push(yearMap[year].income);
            yearlyData.expense.push(yearMap[year].expense);
            yearlyData.profit.push(yearMap[year].income - yearMap[year].expense);
        });
        
        return yearlyData;
    }
    
    // 初始化季度和年度数据
    periodData.quarterly = generateQuarterlyData();
    periodData.yearly = generateYearlyData();
    
    // 更新图表数据
    function updateChart(period) {
        const data = periodData[period];
        const newOption = {
            xAxis: {
                data: data.months
            },
            series: [
                {
                    name: '收入',
                    data: data.income
                },
                {
                    name: '支出',
                    data: data.expense
                },
                {
                    name: '利润',
                    data: data.profit
                }
            ]
        };
        trendChart.setOption(newOption);
    }
    
    // 按钮点击事件
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            const period = this.dataset.period;
            
            // 更新按钮样式
            periodButtons.forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            this.classList.remove('text-gray-600', 'hover:bg-gray-100');
            this.classList.add('bg-primary', 'text-white');
            
            // 更新图表
            currentPeriod = period;
            updateChart(period);
        });
    });

    // 财务健康度仪表盘
    const healthChart = echarts.init(document.getElementById('healthGauge'));
    const healthOption = {
        animation: false,
        series: [
            {
                type: 'gauge',
                center: ['50%', '60%'],
                startAngle: 200,
                endAngle: -20,
                min: 0,
                max: 100,
                splitNumber: 5,
                title: {
                    show: true,
                    offsetCenter: [0, '30%'],
                    fontSize: 14,
                    color: '#64748b'
                },
                itemStyle: {
                    color: '#58D9F9'
                },
                progress: {
                    show: true,
                    width: 20,
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 1, y2: 0,
                            colorStops: [
                                { offset: 0, color: 'rgba(87, 181, 231, 1)' },
                                { offset: 0.5, color: 'rgba(141, 211, 199, 1)' },
                                { offset: 1, color: 'rgba(251, 191, 114, 1)' }
                            ]
                        }
                    }
                },
                pointer: {
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        width: 20,
                        color: [[1, '#f3f4f6']]
                    }
                },
                axisTick: { show: false },
                splitLine: { show: false },
                axisLabel: { show: false },
                detail: {
                    valueAnimation: true,
                    formatter: function(value) {
                        return value.toFixed(1) + '分';
                    },
                    color: '#1f2937',
                    fontSize: 28,
                    fontWeight: 'bold',
                    offsetCenter: [0, '-10%']
                },
                data: [{ value: {{ health_score }}, name: '财务健康度' }]
            }
        ]
    };
    healthChart.setOption(healthOption);

    // 收支分类饼图
    const categoryChart = echarts.init(document.getElementById('categoryChart'));
    const categoryOption = {
        animation: false,
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                return params.marker + params.name + ': ¥' + params.value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' (' + params.percent.toFixed(2) + '%)';
            }
        },
        series: [
            {
                type: 'pie',
                radius: ['30%', '50%'],
                center: ['50%', '50%'],
                data: {{ income_pie_data | tojson }},
                itemStyle: { borderRadius: 8 }
            },
            {
                type: 'pie',
                radius: ['60%', '80%'],
                center: ['50%', '50%'],
                data: {{ expense_pie_data | tojson }},
                itemStyle: { borderRadius: 8 }
            }
        ]
    };
    categoryChart.setOption(categoryOption);

    // 现金流瀑布图
    const cashflowChart = echarts.init(document.getElementById('cashflowChart'));
    const cashflowOption = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                return params[0].name + ': ¥' + params[0].value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        },
        grid: { left: 0, right: 0, top: 30, bottom: 0, containLabel: true },
        xAxis: {
            type: 'category',
            data: ['期初现金', '经营现金流', '投资现金流', '筹资现金流', '期末现金'],
            axisLine: { lineStyle: { color: '#e5e7eb' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLine: { show: false },
            axisTick: { show: false },
            splitLine: { lineStyle: { color: '#f3f4f6' } }
        },
        series: [
            {
                type: 'bar',
                data: {{ cashflow_data | tojson }},
                itemStyle: { borderRadius: [4, 4, 0, 0] }
            }
        ]
    };
    cashflowChart.setOption(cashflowOption);

    // 移动端优化函数
    function optimizeForMobile() {
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            // 优化趋势图表
            const mobileTrendOption = {
                grid: { left: 10, right: 10, top: 60, bottom: 30, containLabel: true },
                legend: {
                    orient: 'horizontal',
                    bottom: 0,
                    itemWidth: 15,
                    itemHeight: 10,
                    textStyle: { fontSize: 10 }
                },
                xAxis: {
                    axisLabel: { fontSize: 10, rotate: 45 }
                },
                yAxis: {
                    axisLabel: { fontSize: 10 }
                },
                tooltip: {
                    textStyle: { fontSize: 12 }
                }
            };
            trendChart.setOption(mobileTrendOption);
            
            // 优化健康度仪表盘
            const mobileHealthOption = {
                series: [{
                    center: ['50%', '55%'],
                    radius: '80%',
                    detail: {
                        fontSize: 20,
                        offsetCenter: [0, '0%']
                    },
                    title: {
                        fontSize: 12,
                        offsetCenter: [0, '35%']
                    }
                }]
            };
            healthChart.setOption(mobileHealthOption);
            
            // 优化分类饼图
            const mobileCategoryOption = {
                series: [
                    {
                        radius: ['20%', '35%'],
                        label: { fontSize: 10 },
                        labelLine: { length: 10, length2: 5 }
                    },
                    {
                        radius: ['45%', '60%'],
                        label: { fontSize: 10 },
                        labelLine: { length: 10, length2: 5 }
                    }
                ],
                tooltip: {
                    textStyle: { fontSize: 12 }
                }
            };
            categoryChart.setOption(mobileCategoryOption);
            
            // 优化现金流图表
            const mobileCashflowOption = {
                grid: { left: 10, right: 10, top: 20, bottom: 30, containLabel: true },
                xAxis: {
                    axisLabel: { fontSize: 9, rotate: 30 }
                },
                yAxis: {
                    axisLabel: { fontSize: 10 }
                },
                tooltip: {
                    textStyle: { fontSize: 12 }
                }
            };
            cashflowChart.setOption(mobileCashflowOption);
        }
    }
    
    // 响应式调整
    window.addEventListener('resize', function() {
        trendChart.resize();
        healthChart.resize();
        categoryChart.resize();
        cashflowChart.resize();
        
        // 延迟执行移动端优化，确保resize完成
        setTimeout(function() {
            optimizeForMobile();
            forceMobileLayout();
        }, 100);
    });
    
    // 初始化时执行移动端优化
    setTimeout(function() {
        optimizeForMobile();
        forceMobileLayout();
    }, 500);
    
    // 强制移动端布局函数
    function forceMobileLayout() {
        if (window.innerWidth <= 768) {
            const gridElements = document.querySelectorAll('.grid[class*="grid-cols-1"][class*="md:grid-cols-4"]');
            gridElements.forEach(function(element) {
                element.style.display = 'grid';
                element.style.gridTemplateColumns = 'repeat(2, 1fr)';
                element.style.gap = '0.75rem';
            });
            
            // 也处理所有包含grid-cols-1的元素
            const allGrids = document.querySelectorAll('.grid[class*="grid-cols-1"]');
            allGrids.forEach(function(element) {
                element.style.gridTemplateColumns = 'repeat(2, 1fr)';
                element.style.gap = '0.5rem';
            });
        }
    }
});

// 自定义时间范围功能
function toggleCustomTime() {
    const panel = document.getElementById('customTimePanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

function applyCustomTime() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('请选择开始日期和结束日期');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('开始日期不能晚于结束日期');
        return;
    }
    
    // 重新加载页面并传递日期参数
    const url = new URL(window.location.href);
    url.searchParams.set('start_date', startDate);
    url.searchParams.set('end_date', endDate);
    window.location.href = url.toString();
}

function resetToDefault() {
    // 移除URL参数并重新加载页面
    const url = new URL(window.location.href);
    url.searchParams.delete('start_date');
    url.searchParams.delete('end_date');
    window.location.href = url.toString();
}

// 导出数据功能
function exportData() {
    showExportModal();
}

// 导出PDF报告功能
function exportPDFReport() {
    // 获取当前的日期参数
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date') || '';
    const endDate = urlParams.get('end_date') || '';
    
    // 构建PDF报告导出URL
    let exportUrl = '/export_pdf_report';
    const params = [];
    if (startDate) params.push('start_date=' + startDate);
    if (endDate) params.push('end_date=' + endDate);
    if (params.length > 0) exportUrl += '?' + params.join('&');
    
    // 创建隐藏的下载链接
    const link = document.createElement('a');
    link.href = exportUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 显示导出模态框
function showExportModal() {
    const modal = document.getElementById('exportModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// 隐藏导出模态框
function hideExportModal() {
    const modal = document.getElementById('exportModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// 点击模态框外部关闭
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('exportModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideExportModal();
        }
    });
    
    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            hideExportModal();
        }
    });
});

// 执行导出
function performExport(format) {
    // 获取当前的日期参数
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date') || '';
    const endDate = urlParams.get('end_date') || '';
    
    // 构建导出URL
    let exportUrl = '/export_statistics?format=' + format;
    if (startDate) exportUrl += '&start_date=' + startDate;
    if (endDate) exportUrl += '&end_date=' + endDate;
    
    // 显示加载状态
    const loadingEl = document.getElementById('exportLoading');
    loadingEl.style.display = 'block';
    
    // 创建隐藏的下载链接
    const link = document.createElement('a');
    link.href = exportUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // 隐藏加载状态和模态框
    setTimeout(() => {
        loadingEl.style.display = 'none';
        hideExportModal();
    }, 500);
}
</script>
{% endblock %}