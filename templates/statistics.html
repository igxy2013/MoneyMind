{% extends "base.html" %}

{% block title %}财务分析 - 七彩果坊{% endblock %}

{% block content %}

<!-- 页面标题 -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">财务分析报表</h1>
    <p class="text-gray-600">深度分析财务数据，洞察经营状况和发展趋势</p>
</div>

<!-- 顶部关键指标 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">总资产</span>
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wallet text-blue-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(total_assets) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if assets_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(assets_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">总负债</span>
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-file-invoice-dollar text-red-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(total_liabilities) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if liabilities_growth >= 0 %}text-red-600{% else %}text-green-600{% endif %}">{{ "{:+.2f}%".format(liabilities_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">净资产</span>
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-chart-line text-green-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "{:,.2f}".format(net_assets) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if net_assets_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(net_assets_growth) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-4">
            <span class="text-gray-600 text-sm">资产负债率</span>
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                <i class="fas fa-balance-scale text-purple-600"></i>
            </div>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">{{ "{:.2f}%".format(liability_ratio) }}</div>
        <div class="flex items-center text-sm">
            <span class="{% if liability_ratio_change <= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ "{:+.2f}%".format(liability_ratio_change) }}</span>
            <span class="text-gray-500 ml-1">较上月</span>
        </div>
    </div>
</div>

<!-- 收支趋势分析 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">收支趋势分析</h3>
            <div class="flex items-center space-x-2" id="periodButtons">
                <button class="px-3 py-1 bg-primary text-white rounded-full text-sm whitespace-nowrap period-btn" data-period="monthly">月度</button>
                <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-full text-sm whitespace-nowrap period-btn" data-period="quarterly">季度</button>
                <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-full text-sm whitespace-nowrap period-btn" data-period="yearly">年度</button>
            </div>
        </div>
        <div id="trendChart" style="height: 300px;"></div>
    </div>

    <!-- 财务健康度评估 -->
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">财务健康度</h3>
        <div class="flex items-center justify-center mb-6">
            <div id="healthGauge" style="height: 200px; width: 100%;"></div>
        </div>
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">偿债能力</span>
                <span class="text-sm font-medium {% if liability_ratio < 30 %}text-green-600{% elif liability_ratio < 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if liability_ratio < 30 %}优秀{% elif liability_ratio < 60 %}良好{% else %}需改善{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">盈利能力</span>
                <span class="text-sm font-medium {% if net_assets > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if net_assets > 0 %}盈利{% else %}亏损{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">营运能力</span>
                <span class="text-sm font-medium {% if health_score >= 80 %}text-green-600{% elif health_score >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if health_score >= 80 %}优秀{% elif health_score >= 60 %}良好{% else %}需改善{% endif %}
                </span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">发展能力</span>
                <span class="text-sm font-medium {% if total_assets > total_liabilities %}text-green-600{% else %}text-blue-600{% endif %}">
                    {% if total_assets > total_liabilities %}稳健{% else %}谨慎{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- 收支分类统计和现金流分析 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">收支分类统计</h3>
        <div class="flex items-center">
            <div id="categoryChart" style="height: 280px; width: 60%;"></div>
            <div class="flex-1 ml-6 space-y-4">
                <div class="border-b border-gray-200 pb-4">
                    <h4 class="font-medium text-gray-900 mb-3">收入构成</h4>
                    <div class="space-y-2">
                        {% for income in income_categories %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">{{ income.name }}</span>
                            </div>
                            <span class="text-sm font-medium">¥{{ "{:,.2f}".format(income.amount) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">支出构成</h4>
                    <div class="space-y-2">
                        {% for expense in expense_categories %}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">{{ expense.name }}</span>
                            </div>
                            <span class="text-sm font-medium">¥{{ "{:,.2f}".format(expense.amount) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
        <h3 class="text-xl font-bold text-gray-900 mb-6">现金流分析</h3>
        <div id="cashflowChart" style="height: 280px;"></div>
    </div>
</div>

<!-- 月度对比分析 -->
<div class="bg-white/70 backdrop-blur-lg rounded-2xl p-8 shadow-lg border border-white/30">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">月度对比分析</h3>
        <div class="flex items-center space-x-3">
            <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-button text-sm whitespace-nowrap hover:bg-gray-200 transition-colors flex items-center">
                <i class="fas fa-download mr-2"></i>
                导出数据
            </button>
            <button class="px-4 py-2 bg-primary text-white rounded-button text-sm whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center">
                <i class="fas fa-calendar mr-2"></i>
                自定义时间
            </button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-medium text-gray-700">月份</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">收入</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">支出</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">利润</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">环比增长</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-700">同比增长</th>
                </tr>
            </thead>
            <tbody>
                {% for month in monthly_data %}
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-4 px-4 font-medium">{{ month.date }}</td>
                    <td class="py-4 px-4 text-right text-green-600 font-medium">¥{{ "{:,.2f}".format(month.income) }}</td>
                    <td class="py-4 px-4 text-right text-red-600 font-medium">¥{{ "{:,.2f}".format(month.expense) }}</td>
                    <td class="py-4 px-4 text-right {% if month.profit < 0 %}text-red-600{% else %}text-green-600{% endif %} font-medium">
                        {{ "¥{:,.2f}".format(month.profit) if month.profit >= 0 else "-¥{:,.2f}".format(-month.profit) }}
                    </td>
                    <td class="py-4 px-4 text-right {% if month.mom_growth < 0 %}text-red-500{% else %}text-green-500{% endif %}">
                        {{ "{:+.2f}%".format(month.mom_growth) }}
                    </td>
                    <td class="py-4 px-4 text-right {% if month.yoy_growth < 0 %}text-red-500{% else %}text-green-500{% endif %}">
                        {{ "{:+.2f}%".format(month.yoy_growth) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 收支趋势图
    const trendChart = echarts.init(document.getElementById('trendChart'));
    const trendOption = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(function(item) {
                    result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '<br/>';
                });
                return result;
            }
        },
        legend: {
            data: ['收入', '支出', '利润'],
            top: 10
        },
        grid: { left: 0, right: 0, top: 50, bottom: 0, containLabel: true },
        xAxis: {
            type: 'category',
            data: {{ trend_months | tojson }},
            axisLine: { lineStyle: { color: '#e5e7eb' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLine: { show: false },
            axisTick: { show: false },
            splitLine: { lineStyle: { color: '#f3f4f6' } }
        },
        series: [
            {
                name: '收入',
                type: 'line',
                smooth: true,
                data: {{ trend_income | tojson }},
                lineStyle: { color: 'rgba(87, 181, 231, 1)', width: 3 },
                itemStyle: { color: 'rgba(87, 181, 231, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(87, 181, 231, 0.1)' },
                            { offset: 1, color: 'rgba(87, 181, 231, 0.01)' }
                        ]
                    }
                }
            },
            {
                name: '支出',
                type: 'line',
                smooth: true,
                data: {{ trend_expense | tojson }},
                lineStyle: { color: 'rgba(252, 141, 98, 1)', width: 3 },
                itemStyle: { color: 'rgba(252, 141, 98, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(252, 141, 98, 0.1)' },
                            { offset: 1, color: 'rgba(252, 141, 98, 0.01)' }
                        ]
                    }
                }
            },
            {
                name: '利润',
                type: 'line',
                smooth: true,
                data: {{ trend_profit | tojson }},
                lineStyle: { color: 'rgba(141, 211, 199, 1)', width: 3 },
                itemStyle: { color: 'rgba(141, 211, 199, 1)' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(141, 211, 199, 0.1)' },
                            { offset: 1, color: 'rgba(141, 211, 199, 0.01)' }
                        ]
                    }
                }
            }
        ]
    };
    trendChart.setOption(trendOption);

    // 时间周期切换功能
    const periodButtons = document.querySelectorAll('.period-btn');
    let currentPeriod = 'monthly';
    
    // 存储不同周期的数据
    const periodData = {
        monthly: {
            months: {{ trend_months | tojson }},
            income: {{ trend_income | tojson }},
            expense: {{ trend_expense | tojson }},
            profit: {{ trend_profit | tojson }}
        },
        quarterly: {
            months: [],
            income: [],
            expense: [],
            profit: []
        },
        yearly: {
            months: [],
            income: [],
            expense: [],
            profit: []
        }
    };
    
    // 生成季度数据
    function generateQuarterlyData() {
        const monthlyData = periodData.monthly;
        const quarterlyData = { months: [], income: [], expense: [], profit: [] };
        
        for (let i = 0; i < monthlyData.months.length; i += 3) {
            const quarterMonths = monthlyData.months.slice(i, i + 3);
            if (quarterMonths.length > 0) {
                const year = quarterMonths[0].split('-')[0];
                const quarter = Math.floor(parseInt(quarterMonths[0].split('-')[1]) / 3) + 1;
                quarterlyData.months.push(`${year}Q${quarter}`);
                
                const quarterIncome = monthlyData.income.slice(i, i + 3).reduce((sum, val) => sum + val, 0);
                const quarterExpense = monthlyData.expense.slice(i, i + 3).reduce((sum, val) => sum + val, 0);
                
                quarterlyData.income.push(quarterIncome);
                quarterlyData.expense.push(quarterExpense);
                quarterlyData.profit.push(quarterIncome - quarterExpense);
            }
        }
        
        return quarterlyData;
    }
    
    // 生成年度数据
    function generateYearlyData() {
        const monthlyData = periodData.monthly;
        const yearlyData = { months: [], income: [], expense: [], profit: [] };
        const yearMap = {};
        
        monthlyData.months.forEach((month, index) => {
            const year = month.split('-')[0];
            if (!yearMap[year]) {
                yearMap[year] = { income: 0, expense: 0 };
            }
            yearMap[year].income += monthlyData.income[index];
            yearMap[year].expense += monthlyData.expense[index];
        });
        
        Object.keys(yearMap).sort().forEach(year => {
            yearlyData.months.push(year);
            yearlyData.income.push(yearMap[year].income);
            yearlyData.expense.push(yearMap[year].expense);
            yearlyData.profit.push(yearMap[year].income - yearMap[year].expense);
        });
        
        return yearlyData;
    }
    
    // 初始化季度和年度数据
    periodData.quarterly = generateQuarterlyData();
    periodData.yearly = generateYearlyData();
    
    // 更新图表数据
    function updateChart(period) {
        const data = periodData[period];
        const newOption = {
            xAxis: {
                data: data.months
            },
            series: [
                {
                    name: '收入',
                    data: data.income
                },
                {
                    name: '支出',
                    data: data.expense
                },
                {
                    name: '利润',
                    data: data.profit
                }
            ]
        };
        trendChart.setOption(newOption);
    }
    
    // 按钮点击事件
    periodButtons.forEach(button => {
        button.addEventListener('click', function() {
            const period = this.dataset.period;
            
            // 更新按钮样式
            periodButtons.forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            this.classList.remove('text-gray-600', 'hover:bg-gray-100');
            this.classList.add('bg-primary', 'text-white');
            
            // 更新图表
            currentPeriod = period;
            updateChart(period);
        });
    });

    // 财务健康度仪表盘
    const healthChart = echarts.init(document.getElementById('healthGauge'));
    const healthOption = {
        animation: false,
        series: [
            {
                type: 'gauge',
                center: ['50%', '60%'],
                startAngle: 200,
                endAngle: -20,
                min: 0,
                max: 100,
                splitNumber: 5,
                title: {
                    show: true,
                    offsetCenter: [0, '20%'],
                    fontSize: 14,
                    color: '#64748b'
                },
                itemStyle: {
                    color: '#58D9F9'
                },
                progress: {
                    show: true,
                    width: 20,
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 1, y2: 0,
                            colorStops: [
                                { offset: 0, color: 'rgba(87, 181, 231, 1)' },
                                { offset: 0.5, color: 'rgba(141, 211, 199, 1)' },
                                { offset: 1, color: 'rgba(251, 191, 114, 1)' }
                            ]
                        }
                    }
                },
                pointer: {
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        width: 20,
                        color: [[1, '#f3f4f6']]
                    }
                },
                axisTick: { show: false },
                splitLine: { show: false },
                axisLabel: { show: false },
                detail: {
                    valueAnimation: true,
                    formatter: function(value) {
                        return value.toFixed(1) + '分';
                    },
                    color: '#1f2937',
                    fontSize: 28,
                    fontWeight: 'bold',
                    offsetCenter: [0, '-10%']
                },
                data: [{ value: {{ health_score }}, name: '财务健康度' }]
            }
        ]
    };
    healthChart.setOption(healthOption);

    // 收支分类饼图
    const categoryChart = echarts.init(document.getElementById('categoryChart'));
    const categoryOption = {
        animation: false,
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                return params.marker + params.name + ': ¥' + params.value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' (' + params.percent.toFixed(2) + '%)';
            }
        },
        series: [
            {
                type: 'pie',
                radius: ['30%', '50%'],
                center: ['50%', '50%'],
                data: {{ income_pie_data | tojson }},
                itemStyle: { borderRadius: 8 }
            },
            {
                type: 'pie',
                radius: ['60%', '80%'],
                center: ['50%', '50%'],
                data: {{ expense_pie_data | tojson }},
                itemStyle: { borderRadius: 8 }
            }
        ]
    };
    categoryChart.setOption(categoryOption);

    // 现金流瀑布图
    const cashflowChart = echarts.init(document.getElementById('cashflowChart'));
    const cashflowOption = {
        animation: false,
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderColor: '#e5e7eb',
            textStyle: { color: '#1f2937' },
            formatter: function(params) {
                return params[0].name + ': ¥' + params[0].value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        },
        grid: { left: 0, right: 0, top: 30, bottom: 0, containLabel: true },
        xAxis: {
            type: 'category',
            data: ['期初现金', '经营现金流', '投资现金流', '筹资现金流', '期末现金'],
            axisLine: { lineStyle: { color: '#e5e7eb' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLine: { show: false },
            axisTick: { show: false },
            splitLine: { lineStyle: { color: '#f3f4f6' } }
        },
        series: [
            {
                type: 'bar',
                data: {{ cashflow_data | tojson }},
                itemStyle: { borderRadius: [4, 4, 0, 0] }
            }
        ]
    };
    cashflowChart.setOption(cashflowOption);

    // 响应式调整
    window.addEventListener('resize', function() {
        trendChart.resize();
        healthChart.resize();
        categoryChart.resize();
        cashflowChart.resize();
    });
});
</script>
{% endblock %}