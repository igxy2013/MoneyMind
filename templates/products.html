{% extends "base.html" %}

{% block title %}商品管理 - 七彩果坊经营管理系统{% endblock %}


{% block extra_head %}


{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8 products-container">
<!-- 页面标题和操作栏 -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">商品管理</h1>
            <p class="text-gray-600">管理商品信息，包括商品分类、库存状态、价格设置等核心数据</p>
        </div>
        <button id="addProductBtn" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center space-x-2">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-plus"></i>
            </div>
            <span>新增商品</span>
        </button>
    </div>
    
    <!-- 搜索和筛选栏 -->
    <div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-64">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <div class="w-5 h-5 flex items-center justify-center">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                    <input type="text" id="searchInput" placeholder="搜索商品名称、编号或描述..." class="w-full pl-10 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <select id="categoryFilter" class="px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm pr-8">
                    <option value="">全部分类</option>
                    <option value="fresh-fruit">新鲜水果</option>
                    <option value="dried-fruit">干果坚果</option>
                    <option value="fruit-juice">果汁饮品</option>
                    <option value="fruit-snack">果脯零食</option>
                </select>
                <select id="stockFilter" class="px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm pr-8">
                    <option value="">库存状态</option>
                    <option value="in-stock">有库存</option>
                    <option value="low-stock">库存不足</option>
                    <option value="out-of-stock">缺货</option>
                </select>
                <button id="advancedFilterBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors flex items-center space-x-2">
                    <div class="w-4 h-4 flex items-center justify-center">
                        <i class="fas fa-filter"></i>
                    </div>
                    <span>高级筛选</span>
                </button>
                <button id="batchActionBtn" class="px-6 py-3 bg-secondary/10 text-secondary rounded-button whitespace-nowrap hover:bg-secondary hover:text-white transition-colors flex items-center space-x-2">
                    <div class="w-4 h-4 flex items-center justify-center">
                        <i class="fas fa-check-square"></i>
                    </div>
                    <span>批量操作</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 商品列表 -->
<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50/80 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-left">
                        <input type="checkbox" id="selectAll" class="w-4 h-4 text-primary rounded">
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">商品图片</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
                        <div class="flex items-center space-x-1">
                            <span>商品名称</span>
                            <div class="w-4 h-4 flex items-center justify-center">
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">商品分类</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
                        <div class="flex items-center space-x-1">
                            <span>售价</span>
                            <div class="w-4 h-4 flex items-center justify-center">
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
                        <div class="flex items-center space-x-1">
                            <span>库存</span>
                            <div class="w-4 h-4 flex items-center justify-center">
                                <i class="fas fa-sort text-gray-400"></i>
                            </div>
                        </div>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">状态</th>
                    <th class="px-6 py-4 text-center text-sm font-semibold text-gray-900">操作</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for product in products %}
                <tr class="hover:bg-gray-50/50 transition-colors cursor-pointer product-row" data-product-id="{{ product.id }}">
                    <td class="px-6 py-4">
                        <input type="checkbox" class="product-checkbox w-4 h-4 text-primary rounded">
                    </td>
                    <td class="px-6 py-4">
                        <div class="w-16 h-16 rounded-xl overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200">
                            {% if product.image_path %}
                                <img src="{{ url_for('static', filename=product.image_path.lstrip('/')) }}" alt="{{ product.name }}" class="w-full h-full object-cover object-center">
                            {% else %}
                                <img src="{{ url_for('static', filename='logo.png') }}" alt="{{ product.name }}" class="w-full h-full object-cover object-center">
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div>
                            <div class="font-semibold text-gray-900">{{ product.name }}</div>
                            <div class="text-sm text-gray-500">编号: PRD{{ '%03d'|format(product.id) }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {% set category_map = {
                                'fresh-fruit': '新鲜水果',
                                'dried-fruit': '干果坚果', 
                                'fruit-juice': '果汁饮品',
                                'fruit-snack': '果脯零食'
                            } %}
                            {{ category_map.get(product.category, product.category or '未分类') }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        {% if product.selling_price %}
                            <div class="font-semibold text-gray-900">¥ {{ '%.2f'|format(product.selling_price) }}/{{ product.unit or '件' }}</div>
                        {% else %}
                            <div class="text-gray-500">未设置</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        {% if product.stock > 50 %}
                            <div class="font-semibold text-green-600">{{ product.stock }} {{ product.unit or '件' }}</div>
                            <div class="text-sm text-green-500">库存充足</div>
                        {% elif product.stock > 10 %}
                            <div class="font-semibold text-orange-600">{{ product.stock }} {{ product.unit or '件' }}</div>
                            <div class="text-sm text-orange-500">库存不足</div>
                        {% else %}
                            <div class="font-semibold text-red-600">{{ product.stock }} {{ product.unit or '件' }}</div>
                            <div class="text-sm text-red-500">库存告急</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        {% if product.is_active %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                在售
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                下架
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-center space-x-2">
                            <button class="w-8 h-8 bg-blue-100 hover:bg-blue-200 rounded-full flex items-center justify-center transition-colors view-detail-btn" title="查看详情" data-product-id="{{ product.id }}">
                                <div class="w-4 h-4 flex items-center justify-center">
                                    <i class="fas fa-eye text-blue-600"></i>
                                </div>
                            </button>
                            <button class="w-8 h-8 bg-green-100 hover:bg-green-200 rounded-full flex items-center justify-center transition-colors edit-product-btn" title="编辑商品" data-product-id="{{ product.id }}">
                                <div class="w-4 h-4 flex items-center justify-center">
                                    <i class="fas fa-edit text-green-600"></i>
                                </div>
                            </button>
                            <button class="w-8 h-8 bg-orange-100 hover:bg-orange-200 rounded-full flex items-center justify-center transition-colors stock-manage-btn" title="库存管理" data-product-id="{{ product.id }}">
                                <div class="w-4 h-4 flex items-center justify-center">
                                    <i class="fas fa-warehouse text-orange-600"></i>
                                </div>
                            </button>
                            <button class="w-8 h-8 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors delete-product-btn" title="删除商品" data-product-id="{{ product.id }}">
                                <div class="w-4 h-4 flex items-center justify-center">
                                    <i class="fas fa-trash text-red-600"></i>
                                </div>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        <div class="flex flex-col items-center space-y-3">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-box-open text-gray-400 text-2xl"></i>
                            </div>
                            <div class="text-lg font-medium">暂无商品数据</div>
                            <div class="text-sm">点击上方"新增商品"按钮添加第一个商品</div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50/50">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                显示 <span class="font-semibold">1</span> 到 <span class="font-semibold">3</span> 条，共 <span class="font-semibold">3</span> 条记录
            </div>
            <div class="flex items-center space-x-2">
                <button class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-button hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    上一页
                </button>
                <button class="px-3 py-2 text-sm bg-primary text-white rounded-button">1</button>
                <button class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-button hover:bg-gray-50 transition-colors">
                    下一页
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑商品模态框 -->
<div id="productModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-4xl mx-4 shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 id="productModalTitle" class="text-2xl font-bold text-gray-900">新增商品</h3>
            <button id="closeProductModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        
        <form id="productForm" class="space-y-8">
            <!-- 隐藏字段标记图片删除状态 -->
            <input type="hidden" id="removeImageFlag" name="remove_image" value="0">
            
            <!-- 商品图片 -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">商品图片</h4>
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl p-8 hover:border-primary transition-colors cursor-pointer" id="imageUploadArea">
                    <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500 mb-2">点击上传或拖拽图片到此处</p>
                    <p class="text-xs text-gray-400">支持 JPG、PNG、GIF 格式，最大 5MB</p>
                    <input type="file" id="productImage" name="image" accept="image/*" class="hidden">
                </div>
                <!-- 图片预览区域 -->
                <div id="imagePreview" class="mt-4 hidden">
                    <div class="text-sm text-gray-600 mb-2">图片预览：</div>
                    <div id="imagePreviewContainer" class="relative inline-block">
                        <img id="previewImage" src="" alt="商品图片预览" class="w-32 h-32 object-cover rounded-lg border border-gray-200">
                        <button type="button" id="removeImage" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 基本信息 -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">基本信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品名称 <span class="text-red-500">*</span></label>
                        <input type="text" id="productName" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品编号</label>
                        <input type="text" id="productCode" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品分类 <span class="text-red-500">*</span></label>
                        <select id="productCategory" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 pr-8">
                            <option value="">请选择分类</option>
                            <option value="fresh-fruit">新鲜水果</option>
                            <option value="dried-fruit">干果坚果</option>
                            <option value="fruit-juice">果汁饮品</option>
                            <option value="fruit-snack">果脯零食</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品状态</label>
                        <select id="productStatus" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 pr-8">
                            <option value="active">在售</option>
                            <option value="inactive">下架</option>
                            <option value="draft">草稿</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">商品描述</label>
                    <textarea id="productDescription" rows="3" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 resize-none"></textarea>
                </div>
                
                <!-- 商品图片已在上方单独区域设置 -->
            </div>
            
            <!-- 价格设置 -->
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">价格设置</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">售价 <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                            <input type="number" id="productPrice" required step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">成本价</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                            <input type="number" id="productCost" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">计量单位</label>
                        <select id="productUnit" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 pr-8">
                            <option value="kg">千克(kg)</option>
                            <option value="g">克(g)</option>
                            <option value="个">个</option>
                            <option value="盒">盒</option>
                            <option value="瓶">瓶</option>
                            <option value="袋">袋</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 库存管理 -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">库存管理</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">当前库存</label>
                        <input type="number" id="currentStock" min="0" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最低库存预警</label>
                        <input type="number" id="minStock" min="0" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最高库存</label>
                        <input type="number" id="maxStock" min="0" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" id="cancelProductBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存商品</button>
            </div>
        </form>
    </div>
</div>

<!-- 商品详情模态框 -->
<div id="productDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-5xl mx-4 shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">商品详情</h3>
            <button id="closeDetailModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        
        <div class="space-y-8">
            <!-- 商品信息 -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">商品信息</h4>
                <div class="flex items-start space-x-6">
                    <div class="w-32 h-32 rounded-2xl overflow-hidden bg-gradient-to-br from-red-100 to-orange-100 flex-shrink-0">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="商品图片" class="w-full h-full object-cover object-center">
                    </div>
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">商品名称</div>
                            <div class="font-semibold text-gray-900">红富士苹果</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">商品编号</div>
                            <div class="font-semibold text-gray-900">FRT001</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">商品分类</div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                新鲜水果
                            </span>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">售价</div>
                            <div class="font-semibold text-gray-900">¥ 12.80/kg</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">成本价</div>
                            <div class="font-semibold text-gray-900">¥ 8.50/kg</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">商品状态</div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                在售
                            </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="text-sm text-gray-500 mb-1">商品描述</div>
                    <div class="text-gray-900">精选山东烟台红富士苹果，果形端正，色泽鲜艳，口感清脆香甜，富含维生素和膳食纤维，是健康生活的优质选择。</div>
                </div>
            </div>
            
            <!-- 库存统计 -->
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">库存统计</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600 mb-1">580 kg</div>
                        <div class="text-sm text-gray-600">当前库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600 mb-1">50 kg</div>
                        <div class="text-sm text-gray-600">最低库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 mb-1">1000 kg</div>
                        <div class="text-sm text-gray-600">最高库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600 mb-1">安全</div>
                        <div class="text-sm text-gray-600">库存状态</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 库存管理模态框 -->
<div id="stockModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-2xl mx-4 shadow-2xl border border-white/20">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">库存管理</h3>
            <button id="closeStockModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        
        <div class="space-y-6">
            <!-- 当前库存信息 -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">当前库存信息</h4>
                <div class="grid grid-cols-2 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2">580 kg</div>
                        <div class="text-sm text-gray-600">当前库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-orange-600 mb-2">50 kg</div>
                        <div class="text-sm text-gray-600">最低库存</div>
                    </div>
                </div>
            </div>
            
            <!-- 库存操作 -->
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">库存操作</h4>
                <form id="stockForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">操作类型</label>
                            <select id="stockOperationType" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 pr-8">
                                <option value="in">入库</option>
                                <option value="out">出库</option>
                                <option value="adjust">调整</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">变动数量</label>
                            <input type="number" id="stockQuantity" min="1" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">操作备注</label>
                        <textarea id="stockRemark" rows="3" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 resize-none" placeholder="请输入操作备注..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelStockBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                        <button type="submit" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">确认操作</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md mx-4 shadow-2xl border border-white/20">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">确认删除</h3>
            <p class="text-gray-600 mb-6">您确定要删除这个商品吗？此操作不可撤销。</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                <button id="confirmDeleteBtn" class="px-6 py-3 bg-red-500 text-white rounded-button whitespace-nowrap hover:bg-red-600 transition-colors">确认删除</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 模态框元素
    const productModal = document.getElementById('productModal');
    const productDetailModal = document.getElementById('productDetailModal');
    const stockModal = document.getElementById('stockModal');
    const deleteModal = document.getElementById('deleteModal');
    
    // 按钮元素
    const addProductBtn = document.getElementById('addProductBtn');
    const closeProductModal = document.getElementById('closeProductModal');
    const closeDetailModal = document.getElementById('closeDetailModal');
    const closeStockModal = document.getElementById('closeStockModal');
    const cancelProductBtn = document.getElementById('cancelProductBtn');
    const cancelStockBtn = document.getElementById('cancelStockBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // 表单元素
    const productForm = document.getElementById('productForm');
    const stockForm = document.getElementById('stockForm');
    const productModalTitle = document.getElementById('productModalTitle');
    
    // 复选框元素
    const selectAll = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    
    // 新增商品
    addProductBtn.addEventListener('click', function() {
        productModalTitle.textContent = '新增商品';
        productForm.reset();
        productForm.removeAttribute('data-edit-id');
        resetImagePreview();
        productModal.classList.remove('hidden');
    });
    
    // 图片处理相关变量定义
    const imageUploadArea = document.getElementById('imageUploadArea');
    const productImage = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const removeImage = document.getElementById('removeImage');
    
    // 重置图片预览函数
    function resetImagePreview() {
        imagePreview.classList.add('hidden');
        previewImage.src = '';
        productImage.value = '';
        document.getElementById('removeImageFlag').value = '0';
    }
    
    // 编辑商品
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            productModalTitle.textContent = '编辑商品';
            
            // 获取商品数据并填充表单
            fetch(`/api/product/${productId}`)
                .then(response => response.json())
                .then(data => {
                    // 填充表单数据
                    document.getElementById('productName').value = data.name || '';
                    document.getElementById('productCategory').value = data.category || '';
                    document.getElementById('productCost').value = data.cost_price || '';
                    document.getElementById('productPrice').value = data.selling_price || '';
                    document.getElementById('productUnit').value = data.unit || '';
                    document.getElementById('productDescription').value = data.description || '';
                    document.getElementById('currentStock').value = data.stock || '';
                    document.getElementById('productStatus').value = data.is_active ? 'active' : 'inactive';
                    
                    // 设置编辑模式
                    productForm.setAttribute('data-edit-id', productId);
                    
                    // 处理商品图片
                    if (data.image_path) {
                        previewImage.src = `/static/${data.image_path}`;
                        imagePreview.classList.remove('hidden');
                        document.getElementById('removeImageFlag').value = '0';
                    } else {
                        resetImagePreview();
                    }
                    
                    productModal.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取商品信息失败，请重试');
                });
        });
    });
    
    // 查看详情
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const productId = this.getAttribute('data-product-id');
            loadProductDetail(productId);
            productDetailModal.classList.remove('hidden');
        });
    });
    
    // 加载商品详情数据
    async function loadProductDetail(productId) {
        try {
            const response = await fetch(`/api/product/${productId}`);
            if (response.ok) {
                const product = await response.json();
                
                // 更新商品图片
                const productImage = document.querySelector('#productDetailModal .w-32.h-32 img');
                if (product.image_path) {
                    productImage.src = `/static/${product.image_path.replace(/^\//, '')}`;
                    productImage.alt = product.name;
                } else {
                    productImage.src = '{{ url_for("static", filename="logo.png") }}';
                    productImage.alt = '商品图片';
                }
                
                // 更新商品信息
                const infoGrid = document.querySelector('#productDetailModal .grid');
                const categoryMap = {
                    'fresh-fruit': '新鲜水果',
                    'dried-fruit': '干果坚果',
                    'fruit-juice': '果汁饮品',
                    'fruit-snack': '果脯零食'
                };
                
                infoGrid.innerHTML = `
                    <div>
                        <div class="text-sm text-gray-500 mb-1">商品名称</div>
                        <div class="font-semibold text-gray-900">${product.name || '-'}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">商品编号</div>
                        <div class="font-semibold text-gray-900">${product.code || '-'}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">商品分类</div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${categoryMap[product.category] || product.category || '未分类'}
                        </span>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">售价</div>
                        <div class="font-semibold text-gray-900">${product.selling_price ? '¥ ' + product.selling_price.toFixed(2) + '/' + (product.unit || '件') : '未设置'}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">成本价</div>
                        <div class="font-semibold text-gray-900">${product.cost_price ? '¥ ' + product.cost_price.toFixed(2) + '/' + (product.unit || '件') : '未设置'}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">商品状态</div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${product.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${product.is_active ? '在售' : '下架'}
                        </span>
                    </div>
                `;
                
                // 更新商品描述
                const descriptionDiv = document.querySelector('#productDetailModal .mt-4 .text-gray-900');
                descriptionDiv.textContent = product.description || '暂无描述';
                
                // 更新库存统计
                const stockGrid = document.querySelector('#productDetailModal .bg-gradient-to-r.from-green-50 .grid');
                const stockStatus = product.stock > 50 ? '充足' : product.stock > 10 ? '不足' : '告急';
                const stockColor = product.stock > 50 ? 'green' : product.stock > 10 ? 'orange' : 'red';
                
                stockGrid.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-${stockColor}-600 mb-1">${product.stock || 0} ${product.unit || '件'}</div>
                        <div class="text-sm text-gray-600">当前库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600 mb-1">${product.min_stock || 10} ${product.unit || '件'}</div>
                        <div class="text-sm text-gray-600">最低库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 mb-1">${product.max_stock || 1000} ${product.unit || '件'}</div>
                        <div class="text-sm text-gray-600">最高库存</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-${stockColor}-600 mb-1">${stockStatus}</div>
                        <div class="text-sm text-gray-600">库存状态</div>
                    </div>
                `;
                
            } else {
                alert('获取商品详情失败');
            }
        } catch (error) {
            console.error('获取商品详情时出错:', error);
            alert('获取商品详情时出错，请重试');
        }
    }
    
    // 库存管理
    document.querySelectorAll('.stock-manage-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            stockModal.classList.remove('hidden');
        });
    });
    
    // 删除商品
    let deleteProductId = null;
    document.querySelectorAll('.delete-product-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            deleteProductId = this.getAttribute('data-product-id');
            deleteModal.classList.remove('hidden');
        });
    });
    
    // 关闭模态框
    closeProductModal.addEventListener('click', () => productModal.classList.add('hidden'));
    closeDetailModal.addEventListener('click', () => productDetailModal.classList.add('hidden'));
    closeStockModal.addEventListener('click', () => stockModal.classList.add('hidden'));
    cancelProductBtn.addEventListener('click', () => productModal.classList.add('hidden'));
    cancelStockBtn.addEventListener('click', () => stockModal.classList.add('hidden'));
    cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
    confirmDeleteBtn.addEventListener('click', function() {
        if (deleteProductId) {
            // 显示加载状态
            const originalText = confirmDeleteBtn.textContent;
            confirmDeleteBtn.textContent = '删除中...';
            confirmDeleteBtn.disabled = true;
            
            // 发送删除请求
            fetch(`/delete_product/${deleteProductId}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    deleteModal.classList.add('hidden');
                    // 刷新页面以更新商品列表
                    window.location.reload();
                } else {
                    alert(data.message || '删除失败，请重试');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败，请重试');
            })
            .finally(() => {
                // 恢复按钮状态
                confirmDeleteBtn.textContent = originalText;
                confirmDeleteBtn.disabled = false;
                deleteProductId = null;
            });
        } else {
            deleteModal.classList.add('hidden');
        }
    });
    
    // 点击背景关闭模态框
    [productModal, productDetailModal, stockModal, deleteModal].forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });
    
    // 表单提交
    productForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 检查是否为编辑模式
        const editId = productForm.getAttribute('data-edit-id');
        const isEdit = editId && editId !== '';
        
        // 收集表单数据
        const formData = new FormData();
        formData.append('name', document.getElementById('productName').value);
        formData.append('category', document.getElementById('productCategory').value);
        formData.append('cost_price', document.getElementById('productCost').value);
        formData.append('selling_price', document.getElementById('productPrice').value);
        formData.append('unit', document.getElementById('productUnit').value);
        formData.append('description', document.getElementById('productDescription').value);
        formData.append('stock', document.getElementById('currentStock').value || '0');
        formData.append('is_active', document.getElementById('productStatus').value === 'active' ? '1' : '0');
        
        // 添加图片文件
        const imageFile = document.getElementById('productImage').files[0];
        if (imageFile) {
            formData.append('image', imageFile);
        }
        
        // 添加图片删除标记
        const removeImageFlag = document.getElementById('removeImageFlag').value;
        formData.append('remove_image', removeImageFlag);
        
        // 显示加载状态
        const submitBtn = productForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = isEdit ? '更新中...' : '保存中...';
        submitBtn.disabled = true;
        
        // 确定请求URL
        const url = isEdit ? `/edit_product/${editId}` : '/add_product';
        
        // 发送AJAX请求
        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                productModal.classList.add('hidden');
                productForm.reset();
                productForm.removeAttribute('data-edit-id');
                resetImagePreview();
                // 刷新页面以显示更新的商品
                window.location.reload();
            } else {
                alert((isEdit ? '更新失败：' : '添加失败：') + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(isEdit ? '更新失败，请重试' : '添加失败，请重试');
        })
        .finally(() => {
            // 恢复按钮状态
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });
    
    stockForm.addEventListener('submit', function(e) {
        e.preventDefault();
        // 这里添加库存操作逻辑
        stockModal.classList.add('hidden');
    });
    
    // 图片处理功能
    
    // 图片上传区域点击事件
    imageUploadArea.addEventListener('click', function() {
        productImage.click();
    });
    
    // 图片文件选择处理
    productImage.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }
            
            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                imagePreview.classList.remove('hidden');
                // 重置删除标记
                document.getElementById('removeImageFlag').value = '0';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // 移除图片按钮
    removeImage.addEventListener('click', function() {
        imagePreview.classList.add('hidden');
        previewImage.src = '';
        productImage.value = '';
        // 设置删除标记
        document.getElementById('removeImageFlag').value = '1';
    });
    
    // 重置图片预览函数已在前面定义
    
    // 全选功能
    selectAll.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    });
    
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
            selectAll.checked = checkedCount === productCheckboxes.length;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < productCheckboxes.length;
        });
    });
    
    // 搜索和筛选功能
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const stockFilter = document.getElementById('stockFilter');
    const productRows = document.querySelectorAll('.product-row');
    
    function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const stockValue = stockFilter.value;
        
        // 分类映射
        const categoryMap = {
            'fresh-fruit': '新鲜水果',
            'dried-fruit': '干果坚果',
            'fruit-juice': '果汁饮品',
            'fruit-snack': '果脯零食'
        };
        
        productRows.forEach(row => {
            const productName = row.querySelector('td:nth-child(3) .font-semibold').textContent.toLowerCase();
            const productCategory = row.querySelector('td:nth-child(4) span').textContent.trim();
            const stockStatus = row.querySelector('td:nth-child(6) .text-sm').textContent.toLowerCase();
            
            let showRow = true;
            
            // 搜索过滤
            if (searchTerm && !productName.includes(searchTerm)) {
                showRow = false;
            }
            
            // 分类过滤
            if (categoryValue) {
                const expectedCategoryText = categoryMap[categoryValue];
                if (expectedCategoryText && productCategory !== expectedCategoryText) {
                    showRow = false;
                }
            }
            
            // 库存状态过滤
            if (stockValue) {
                if (stockValue === 'in-stock' && stockStatus.includes('缺货')) {
                    showRow = false;
                } else if (stockValue === 'out-of-stock' && !stockStatus.includes('缺货')) {
                    showRow = false;
                }
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    // 绑定搜索和筛选事件
    searchInput.addEventListener('input', filterProducts);
    categoryFilter.addEventListener('change', filterProducts);
    stockFilter.addEventListener('change', filterProducts);
    
    // 第二个图片上传区域相关的JavaScript代码已删除，因为对应的HTML元素已被移除
    
    // 为第一个图片上传区域添加拖拽上传功能
    imageUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        imageUploadArea.classList.add('border-primary');
    });
    
    imageUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        imageUploadArea.classList.remove('border-primary');
    });
    
    imageUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        imageUploadArea.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                if (file.size <= 5 * 1024 * 1024) {
                    productImage.files = files;
                    // 触发change事件来处理图片预览
                    const event = new Event('change', { bubbles: true });
                    productImage.dispatchEvent(event);
                } else {
                    alert('图片文件大小不能超过5MB！');
                }
            } else {
                alert('请选择图片文件！');
            }
        }
    });
    
    // 移动端布局强制函数
    function forceMobileLayout() {
        if (window.innerWidth <= 768) {
            // 强制搜索筛选栏为垂直布局
            const searchAreas = document.querySelectorAll('.flex.flex-wrap.items-center.gap-4');
            searchAreas.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.alignItems = 'stretch';
                element.style.gap = '1rem';
            });
            
            // 强制按钮组为垂直布局
            const buttonGroups = document.querySelectorAll('.flex.items-center.space-x-4');
            buttonGroups.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.gap = '0.5rem';
                element.style.width = '100%';
            });
            
            // 强制搜索框宽度
            const searchInputs = document.querySelectorAll('.flex-1.min-w-64');
            searchInputs.forEach(function(element) {
                element.style.minWidth = 'auto';
                element.style.width = '100%';
            });
        }
    }
    
    // 窗口大小变化时重新应用移动端布局
    window.addEventListener('resize', function() {
        setTimeout(forceMobileLayout, 100);
    });
    
    // 页面加载完成后执行
    setTimeout(forceMobileLayout, 500);
});
</script>
</div>
{% endblock %}