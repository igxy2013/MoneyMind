{% extends "base.html" %}

{% block title %}应收款管理 - MoneyMind{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto receivables-container">
<div class="mb-8">
<div class="flex items-center justify-between mb-8">
<div>
<h1 class="text-3xl font-bold text-gray-900 mb-2">应收款管理</h1>
<p class="text-gray-600">管理客户应收账款，跟踪逾期情况，记录催收进度和收款状态</p>
</div>
<a href="{{ url_for('add_receivable') }}" id="addReceivableBtn" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center space-x-2">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-add-line"></i>
</div>
<span>新增应收款</span>
</a>
</div>

<!-- 应收款总览卡片 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
<div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20">
<div class="flex items-center justify-between">
<div>
<p class="text-sm text-gray-600 mb-1">应收总额</p>
<p class="text-2xl font-bold text-gray-900">¥ {{ "{:,.2f}".format(total_amount) }}</p>
</div>
<div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-money-dollar-circle-line text-blue-600"></i>
</div>
</div>
</div>
</div>
<div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20">
<div class="flex items-center justify-between">
<div>
<p class="text-sm text-gray-600 mb-1">已收金额</p>
<p class="text-2xl font-bold text-green-600">¥ {{ "{:,.2f}".format(received_amount) }}</p>
</div>
<div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-check-double-line text-green-600"></i>
</div>
</div>
</div>
</div>
<div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20">
<div class="flex items-center justify-between">
<div>
<p class="text-sm text-gray-600 mb-1">逾期金额</p>
<p class="text-2xl font-bold text-red-600">¥ {{ "{:,.2f}".format(overdue_amount) }}</p>
</div>
<div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-alarm-warning-line text-red-600"></i>
</div>
</div>
</div>
</div>
<div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20">
<div class="flex items-center justify-between">
<div>
<p class="text-sm text-gray-600 mb-1">待收金额</p>
<p class="text-2xl font-bold text-orange-600">¥ {{ "{:,.2f}".format(pending_amount) }}</p>
</div>
<div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-time-line text-orange-600"></i>
</div>
</div>
</div>
</div>
</div>

<!-- 搜索和筛选区域 -->
<div class="bg-white/60 backdrop-blur-lg rounded-2xl p-6 shadow-lg border border-white/20 mb-6">
<div class="flex flex-wrap items-center gap-4">
<div class="flex-1 min-w-64">
<div class="relative">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<div class="w-5 h-5 flex items-center justify-center">
<i class="ri-search-line text-gray-400"></i>
</div>
</div>
<input type="text" id="searchInput" placeholder="搜索客户名称、单号或联系方式..." class="w-full pl-10 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
</div>
</div>
<div class="flex items-center space-x-4">
<div class="flex items-center space-x-2">
<input type="date" id="startDate" class="px-3 py-2 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm" placeholder="开始日期">
<span class="text-gray-500">至</span>
<input type="date" id="endDate" class="px-3 py-2 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm" placeholder="结束日期">
</div>
<select id="statusFilter" class="px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm pr-8">
<option value="">全部状态</option>
<option value="unpaid">未收</option>
<option value="partial">部分收</option>
<option value="paid">已收</option>
<option value="overdue">逾期</option>
</select>
<select id="customerFilter" class="px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm pr-8">
<option value="">全部客户</option>
<option value="customer1">华润万家超市</option>
<option value="customer2">永辉超市</option>
<option value="customer3">家乐福</option>
<option value="customer4">沃尔玛</option>
</select>
<button id="resetFilterBtn" class="px-6 py-3 bg-orange-100 text-orange-700 rounded-button whitespace-nowrap hover:bg-orange-200 transition-colors flex items-center space-x-2">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-refresh-line"></i>
</div>
<span>重置筛选</span>
</button>
<button id="advancedFilterBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors flex items-center space-x-2">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-filter-line"></i>
</div>
<span>高级筛选</span>
</button>
<button id="batchActionBtn" class="px-6 py-3 bg-secondary/10 text-secondary rounded-button whitespace-nowrap hover:bg-secondary hover:text-white transition-colors flex items-center space-x-2">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-checkbox-multiple-line"></i>
</div>
<span>批量操作</span>
</button>
</div>
</div>
</div>

<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 overflow-hidden">
<div class="overflow-x-auto">
<table class="w-full">
<thead class="bg-gray-50/80 border-b border-gray-200">
<tr>
<th class="px-6 py-4 text-left">
<input type="checkbox" id="selectAll" class="w-4 h-4 text-primary rounded">
</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
<div class="flex items-center space-x-1">
<span>单号</span>
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-arrow-up-down-line text-gray-400"></i>
</div>
</div>
</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">客户信息</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
<div class="flex items-center space-x-1">
<span>应收金额</span>
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-arrow-up-down-line text-gray-400"></i>
</div>
</div>
</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">已收金额</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 cursor-pointer hover:text-primary transition-colors">
<div class="flex items-center space-x-1">
<span>账期</span>
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-arrow-up-down-line text-gray-400"></i>
</div>
</div>
</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">逾期天数</th>
<th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">状态</th>
<th class="px-6 py-4 text-center text-sm font-semibold text-gray-900">操作</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-100">
{% for receivable in receivables %}
<tr class="hover:bg-gray-50/50 transition-colors cursor-pointer receivable-row">
<td class="px-6 py-4">
<input type="checkbox" class="receivable-checkbox w-4 h-4 text-primary rounded">
</td>
<td class="px-6 py-4">
<div class="font-semibold text-gray-900">{{ receivable.receivable_number or 'AR' + receivable.id|string }}</div>
<div class="text-sm text-gray-500">{{ receivable.invoice_date.strftime('%Y-%m-%d') if receivable.invoice_date else (receivable.created_at.strftime('%Y-%m-%d') if receivable.created_at else '未设置') }}</div>
</td>
<td class="px-6 py-4">
<div>
<div class="font-semibold text-gray-900">{{ receivable.title }}</div>
{% if receivable.contact_person %}
<div class="text-sm text-gray-500">联系人：{{ receivable.contact_person }}</div>
{% endif %}
{% if receivable.contact_phone %}
<div class="text-sm text-gray-500">电话：{{ receivable.contact_phone }}</div>
{% endif %}
</div>
</td>
<td class="px-6 py-4">
<div class="font-semibold text-gray-900">¥ {{ "{:,.2f}".format(receivable.amount) }}</div>
</td>
<td class="px-6 py-4">
<div class="font-semibold {% if receivable.received_amount > 0 %}text-green-600{% else %}text-gray-600{% endif %}">¥ {{ "{:,.2f}".format(receivable.received_amount) }}</div>
</td>
<td class="px-6 py-4">
<div class="text-gray-900">{{ receivable.due_date.strftime('%Y-%m-%d') if receivable.due_date else '未设置' }}</div>
{% if receivable.payment_terms %}
<div class="text-sm text-gray-500">{{ receivable.payment_terms }} 天账期</div>
{% endif %}
</td>
<td class="px-6 py-4">
{% if receivable.overdue_days and receivable.overdue_days > 0 %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
逾期 {{ receivable.overdue_days }} 天
</span>
{% elif receivable.days_until_due is not none and receivable.days_until_due >= 0 %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
还有 {{ receivable.days_until_due }} 天
</span>
{% else %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
-
</span>
{% endif %}
</td>
<td class="px-6 py-4">
{% if receivable.status == 'received' %}
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
已收款
</span>
{% elif receivable.status == 'partial' %}
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
部分收款
</span>
{% else %}
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
未收款
</span>
{% endif %}
</td>
<td class="px-6 py-4">
<div class="flex items-center justify-center space-x-2">
<button class="w-8 h-8 bg-blue-100 hover:bg-blue-200 rounded-full flex items-center justify-center transition-colors view-detail-btn" data-id="{{ receivable.id }}">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-eye-line text-blue-600"></i>
</div>
</button>
<button class="w-8 h-8 bg-green-100 hover:bg-green-200 rounded-full flex items-center justify-center transition-colors payment-record-btn" data-id="{{ receivable.id }}">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-money-dollar-circle-line text-green-600"></i>
</div>
</button>
<button class="w-8 h-8 bg-purple-100 hover:bg-purple-200 rounded-full flex items-center justify-center transition-colors collection-record-btn" data-id="{{ receivable.id }}">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-phone-line text-purple-600"></i>
</div>
</button>
<a href="{{ url_for('mark_received', id=receivable.id) }}" class="w-8 h-8 bg-orange-100 hover:bg-orange-200 rounded-full flex items-center justify-center transition-colors" onclick="return confirm('确认标记为已收款？')">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-check-line text-orange-600"></i>
</div>
</a>
</div>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
<div class="px-6 py-4 border-t border-gray-200 bg-gray-50/50">
<div class="flex items-center justify-between">
<div class="text-sm text-gray-700">
共 <span class="font-semibold">{{ receivables|length }}</span> 条记录
</div>
</div>
</div>
</div>
</div>

<!-- 新增/编辑应收款模态框 -->
<div id="receivableModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
<div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-4xl mx-4 shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
<div class="flex items-center justify-between mb-6">
<h3 id="receivableModalTitle" class="text-2xl font-bold text-gray-900">新增应收款</h3>
<button id="closeReceivableModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-close-line text-gray-600"></i>
</div>
</button>
</div>
<form id="receivableForm" method="POST" action="{{ url_for('add_receivable') }}" class="space-y-8">
<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">基本信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">应收款单号 <span class="text-red-500">*</span></label>
<input type="text" name="receivable_number" id="receivableNumber" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" value="AR202402001">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">客户名称 <span class="text-red-500">*</span></label>
<input type="text" name="title" id="customerName" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="请输入客户名称">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">应收金额 <span class="text-red-500">*</span></label>
<div class="relative">
<span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
<input type="number" name="amount" id="receivableAmount" required step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">账期天数</label>
<input type="number" name="payment_terms" id="paymentTerms" min="0" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" value="30">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">开票日期 <span class="text-red-500">*</span></label>
<input type="date" name="invoice_date" id="invoiceDate" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">到期日期</label>
<input type="date" name="due_date" id="dueDate" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">备注说明</label>
<textarea name="notes" id="receivableRemark" rows="3" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 resize-none" placeholder="请输入相关备注信息..."></textarea>
</div>
</div>
<div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">联系信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">联系人</label>
<input type="text" name="contact_person" id="contactPerson" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
<input type="tel" name="contact_phone" id="contactPhone" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">联系地址</label>
<input type="text" name="contact_address" id="contactAddress" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
</div>
</div>
</div>
<div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
<button type="button" id="cancelReceivableBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
<button type="submit" id="saveReceivableBtn" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存应收款</button>
</div>
</form>
</div>
</div>

<!-- 应收款详情模态框 -->
<div id="receivableDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
<div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-5xl mx-4 shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto">
<div class="flex items-center justify-between mb-6">
<h3 class="text-2xl font-bold text-gray-900">应收款详情</h3>
<button id="closeDetailModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
<i class="ri-close-line text-gray-600"></i>
</button>
</div>
<div class="space-y-8">
<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">应收款信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<div>
<div class="text-sm text-gray-500 mb-1">单号</div>
<div class="font-semibold text-gray-900">AR202401001</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">客户名称</div>
<div class="font-semibold text-gray-900">华润万家超市</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">应收金额</div>
<div class="font-semibold text-gray-900">¥ 58,600.00</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">已收金额</div>
<div class="font-semibold text-green-600">¥ 35,000.00</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">未收金额</div>
<div class="font-semibold text-red-600">¥ 23,600.00</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">开票日期</div>
<div class="font-semibold text-gray-900">2024-01-15</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">到期日期</div>
<div class="font-semibold text-gray-900">2024-02-15</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">逾期天数</div>
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
逾期 15 天
</span>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">状态</div>
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
部分收款
</span>
</div>
</div>
</div>
<div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">客户信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<div>
<div class="text-sm text-gray-500 mb-1">联系人</div>
<div class="font-semibold text-gray-900">李经理</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">联系电话</div>
<div class="font-semibold text-gray-900">138-0001-2345</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">客户地址</div>
<div class="font-semibold text-gray-900">深圳市南山区科技园南区</div>
</div>
</div>
</div>
<div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">收款记录</h4>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr class="border-b border-gray-200">
<th class="text-left py-2 text-gray-700">收款日期</th>
<th class="text-left py-2 text-gray-700">收款金额</th>
<th class="text-left py-2 text-gray-700">收款方式</th>
<th class="text-left py-2 text-gray-700">操作人</th>
<th class="text-left py-2 text-gray-700">备注</th>
</tr>
</thead>
<tbody>
<tr class="border-b border-gray-100">
<td class="py-3 text-gray-900">2024-01-25</td>
<td class="py-3 text-green-600 font-semibold">¥ 20,000.00</td>
<td class="py-3 text-gray-900">银行转账</td>
<td class="py-3 text-gray-900">张明华</td>
<td class="py-3 text-gray-600">首期付款</td>
</tr>
<tr class="border-b border-gray-100">
<td class="py-3 text-gray-900">2024-02-05</td>
<td class="py-3 text-green-600 font-semibold">¥ 15,000.00</td>
<td class="py-3 text-gray-900">现金</td>
<td class="py-3 text-gray-900">李雅琳</td>
<td class="py-3 text-gray-600">二期付款</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">催收记录</h4>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr class="border-b border-gray-200">
<th class="text-left py-2 text-gray-700">催收时间</th>
<th class="text-left py-2 text-gray-700">催收方式</th>
<th class="text-left py-2 text-gray-700">催收人</th>
<th class="text-left py-2 text-gray-700">客户反馈</th>
<th class="text-left py-2 text-gray-700">下次跟进</th>
</tr>
</thead>
<tbody>
<tr class="border-b border-gray-100">
<td class="py-3 text-gray-900">2024-02-16</td>
<td class="py-3 text-gray-900">电话催收</td>
<td class="py-3 text-gray-900">王建国</td>
<td class="py-3 text-gray-600">承诺本周内付款</td>
<td class="py-3 text-gray-900">2024-02-23</td>
</tr>
<tr class="border-b border-gray-100">
<td class="py-3 text-gray-900">2024-02-20</td>
<td class="py-3 text-gray-900">上门拜访</td>
<td class="py-3 text-gray-900">张明华</td>
<td class="py-3 text-gray-600">资金周转困难，申请延期</td>
<td class="py-3 text-gray-900">2024-02-27</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- 收款登记模态框 -->
<div id="paymentModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
<div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-2xl mx-4 shadow-2xl border border-white/20">
<div class="flex items-center justify-between mb-6">
<h3 class="text-2xl font-bold text-gray-900">收款登记</h3>
<button id="closePaymentModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
<i class="ri-close-line text-gray-600"></i>
</button>
</div>
<div class="space-y-6">
<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">应收款信息</h4>
<div class="grid grid-cols-2 gap-6">
<div>
<div class="text-sm text-gray-500 mb-1">应收总额</div>
<div class="text-xl font-bold text-gray-900">¥ 58,600.00</div>
</div>
<div>
<div class="text-sm text-gray-500 mb-1">未收金额</div>
<div class="text-xl font-bold text-red-600">¥ 23,600.00</div>
</div>
</div>
</div>
<div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">收款信息</h4>
<form id="paymentForm" class="space-y-4" method="POST">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收款金额 *</label>
<input type="number" name="received_amount" step="0.01" placeholder="请输入收款金额" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收款日期 *</label>
<input type="date" name="received_date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收款方式 *</label>
<select name="payment_method" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
<option value="">请选择收款方式</option>
<option value="bank_transfer">银行转账</option>
<option value="cash">现金</option>
<option value="check">支票</option>
<option value="other">其他</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收款备注</label>
<textarea name="payment_notes" rows="3" placeholder="请输入收款备注" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
</div>
</form>
</div>
<div class="flex justify-end space-x-4">
<button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-colors">
取消
</button>
<button class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-xl transition-all transform hover:scale-105">
确认收款
</button>
</div>
</div>
</div>
</div>

<!-- 催收记录模态框 -->
<div id="collectionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
<div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-2xl mx-4 shadow-2xl border border-white/20">
<div class="flex items-center justify-between mb-6">
<h3 class="text-2xl font-bold text-gray-900">催收记录</h3>
<button id="closeCollectionModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
<i class="ri-close-line text-gray-600"></i>
</button>
</div>
<div class="space-y-6">
<div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-6">
<h4 class="text-lg font-semibold text-gray-900 mb-4">新增催收记录</h4>
<form class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">催收方式 *</label>
<select class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
<option value="">请选择催收方式</option>
<option value="phone">电话催收</option>
<option value="email">邮件催收</option>
<option value="visit">上门拜访</option>
<option value="letter">催收函</option>
<option value="other">其他</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">催收时间 *</label>
<input type="datetime-local" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">催收人 *</label>
<input type="text" placeholder="请输入催收人姓名" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">客户反馈</label>
<textarea rows="3" placeholder="请输入客户反馈内容" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">下次跟进时间</label>
<input type="date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">备注说明</label>
<textarea rows="3" placeholder="请输入备注说明" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
</div>
</form>
</div>
<div class="flex justify-end space-x-4">
<button class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-colors">
取消
</button>
<button class="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white rounded-xl transition-all transform hover:scale-105">
保存记录
</button>
</div>
</div>
</div>
</div>

<script>
// 等待DOM加载完成
document.addEventListener('DOMContentLoaded', function() {
    // 模态框控制
    const receivableModal = document.getElementById('receivableModal');
    const closeReceivableModal = document.getElementById('closeReceivableModal');
    const receivableDetailModal = document.getElementById('receivableDetailModal');
    const closeDetailModal = document.getElementById('closeDetailModal');
    const paymentModal = document.getElementById('paymentModal');
    const closePaymentModal = document.getElementById('closePaymentModal');
    const collectionModal = document.getElementById('collectionModal');
    const closeCollectionModal = document.getElementById('closeCollectionModal');

    // 新增应收款模态框
    const addReceivableBtn = document.getElementById('addReceivableBtn');
    if (addReceivableBtn) {
        addReceivableBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('按钮被点击'); // 调试信息
            receivableModal.classList.remove('hidden');
            receivableModal.style.display = 'flex';
            receivableModal.style.alignItems = 'center';
            receivableModal.style.justifyContent = 'center';
            // 生成新的应收款单号
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            const receivableNumberInput = document.getElementById('receivableNumber');
            if (receivableNumberInput) {
                receivableNumberInput.value = `AR${year}${month}${day}${random}`;
            }
        });
    } else {
        console.log('未找到新增应收款按钮');
    }

    if (closeReceivableModal) {
        closeReceivableModal.addEventListener('click', () => {
            receivableModal.classList.add('hidden');
            receivableModal.style.display = 'none';
        });
    }

    // 取消按钮
    const cancelReceivableBtn = document.getElementById('cancelReceivableBtn');
    if (cancelReceivableBtn) {
        cancelReceivableBtn.addEventListener('click', () => {
            receivableModal.classList.add('hidden');
            receivableModal.style.display = 'none';
        });
    }

    // 点击模态框外部关闭
    if (receivableModal) {
        receivableModal.addEventListener('click', (e) => {
            if (e.target === receivableModal) {
                receivableModal.classList.add('hidden');
                receivableModal.style.display = 'none';
            }
        });
    }

    // 应收款详情模态框
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            receivableDetailModal.classList.remove('hidden');
        });
    });

    if (closeDetailModal) {
        closeDetailModal.addEventListener('click', () => {
            receivableDetailModal.classList.add('hidden');
        });
    }

    // 收款登记模态框
    let currentReceivableId = null;
    document.querySelectorAll('.payment-record-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentReceivableId = btn.getAttribute('data-id');
            paymentModal.classList.remove('hidden');
            // 设置表单action
            const paymentForm = document.getElementById('paymentForm');
            paymentForm.action = `/receivables/${currentReceivableId}/receive`;
            // 设置默认收款日期为今天
            const dateInput = paymentForm.querySelector('input[name="received_date"]');
            dateInput.value = new Date().toISOString().split('T')[0];
        });
    });

    // 确认收款按钮
    const confirmPaymentBtn = document.querySelector('#paymentModal button[type="button"]:last-child');
    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', () => {
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm.checkValidity()) {
                paymentForm.submit();
            } else {
                paymentForm.reportValidity();
            }
        });
    }

    if (closePaymentModal) {
        closePaymentModal.addEventListener('click', () => {
            paymentModal.classList.add('hidden');
        });
    }

    // 催收记录模态框
    document.querySelectorAll('.collection-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            collectionModal.classList.remove('hidden');
        });
    });

    if (closeCollectionModal) {
        closeCollectionModal.addEventListener('click', () => {
            collectionModal.classList.add('hidden');
        });
    }

    // 点击模态框背景关闭
    [receivableDetailModal, paymentModal, collectionModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
    });

    // receivableModal的外部点击关闭已在上面单独处理

    // ESC键关闭模态框
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            [receivableModal, receivableDetailModal, paymentModal, collectionModal].forEach(modal => {
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        }
    });

    // 筛选功能
    const statusFilter = document.getElementById('statusFilter');
    const customerFilter = document.getElementById('customerFilter');
    const searchInput = document.getElementById('searchInput');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const receivableRows = document.querySelectorAll('.receivable-row');

    // 筛选函数
    function filterReceivables() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const statusValue = statusFilter ? statusFilter.value : '';
        const customerValue = customerFilter ? customerFilter.value : '';
        const startDateValue = startDate ? startDate.value : '';
        const endDateValue = endDate ? endDate.value : '';
        
        let visibleCount = 0;
        
        receivableRows.forEach(row => {
            const receivableNumber = row.querySelector('td:nth-child(2) .font-semibold').textContent.toLowerCase();
            const customerName = row.querySelector('td:nth-child(3) .font-semibold').textContent.toLowerCase();
            const contactInfo = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const statusElement = row.querySelector('td:nth-child(8) span');
            const statusText = statusElement ? statusElement.textContent.trim() : '';
            
            // 搜索匹配
            const matchesSearch = !searchTerm || 
                receivableNumber.includes(searchTerm) || 
                customerName.includes(searchTerm) || 
                contactInfo.includes(searchTerm);
            
            // 状态匹配
            let matchesStatus = !statusValue;
            if (statusValue) {
                switch (statusValue) {
                    case 'unpaid':
                        matchesStatus = statusText.includes('未收');
                        break;
                    case 'partial':
                        matchesStatus = statusText.includes('部分');
                        break;
                    case 'paid':
                        matchesStatus = statusText.includes('已收');
                        break;
                    case 'overdue':
                        matchesStatus = statusText.includes('逾期');
                        break;
                }
            }
            
            // 客户匹配（基于客户名称）
            let matchesCustomer = !customerValue;
            if (customerValue) {
                switch (customerValue) {
                    case 'customer1':
                        matchesCustomer = customerName.includes('华润万家');
                        break;
                    case 'customer2':
                        matchesCustomer = customerName.includes('永辉');
                        break;
                    case 'customer3':
                        matchesCustomer = customerName.includes('家乐福');
                        break;
                    case 'customer4':
                        matchesCustomer = customerName.includes('沃尔玛');
                        break;
                }
            }
            
            // 日期范围匹配（基于开票日期）
            let matchesDateRange = true;
            const dateElement = row.querySelector('td:nth-child(2) .text-sm');
            if (dateElement && (startDateValue || endDateValue)) {
                const dateText = dateElement.textContent.trim();
                if (dateText && dateText !== '未设置') {
                    const rowDate = new Date(dateText);
                    if (startDateValue) {
                        const startDateObj = new Date(startDateValue);
                        if (rowDate < startDateObj) {
                            matchesDateRange = false;
                        }
                    }
                    if (endDateValue && matchesDateRange) {
                        const endDateObj = new Date(endDateValue);
                        if (rowDate > endDateObj) {
                            matchesDateRange = false;
                        }
                    }
                } else if (startDateValue || endDateValue) {
                    matchesDateRange = false;
                }
            }
            
            // 显示或隐藏行
            if (matchesSearch && matchesStatus && matchesCustomer && matchesDateRange) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新记录数显示
        const recordCountElement = document.querySelector('.text-sm.text-gray-700 .font-semibold');
        if (recordCountElement) {
            recordCountElement.textContent = visibleCount;
        }
    }

    // 绑定事件监听器
    if (statusFilter) {
        statusFilter.addEventListener('change', filterReceivables);
    }

    if (customerFilter) {
        customerFilter.addEventListener('change', filterReceivables);
    }

    if (searchInput) {
        searchInput.addEventListener('input', filterReceivables);
    }

    if (startDate) {
        startDate.addEventListener('change', filterReceivables);
    }

    if (endDate) {
        endDate.addEventListener('change', filterReceivables);
    }

    // 重置筛选
    function resetFilters() {
        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = '';
        if (customerFilter) customerFilter.value = '';
        if (startDate) startDate.value = '';
        if (endDate) endDate.value = '';
        filterReceivables();
    }

    // 重置筛选按钮功能
    const resetFilterBtn = document.getElementById('resetFilterBtn');
    if (resetFilterBtn) {
        resetFilterBtn.addEventListener('click', resetFilters);
    }

    // 高级筛选按钮功能
    const advancedFilterBtn = document.getElementById('advancedFilterBtn');
    if (advancedFilterBtn) {
        advancedFilterBtn.addEventListener('click', () => {
            // 可以在这里添加高级筛选模态框
            alert('高级筛选功能开发中...');
        });
    }

    // 全选功能
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('input[type="checkbox"]:not(#selectAll)');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
    }

    // 批量操作
    const batchActionBtn = document.getElementById('batchActionBtn');
    if (batchActionBtn) {
        batchActionBtn.addEventListener('click', () => {
            const selectedRows = Array.from(rowCheckboxes).filter(cb => cb.checked);
            if (selectedRows.length === 0) {
                alert('请先选择要操作的应收款记录');
                return;
            }
            // 这里可以添加批量操作逻辑
            console.log('批量操作:', selectedRows.length + '条记录');
        });
    }
    
    // 移动端布局强制函数
    function forceMobileLayout() {
        if (window.innerWidth <= 768) {
            // 强制应收款总览卡片为2列布局
            const gridElements = document.querySelectorAll('.grid[class*="grid-cols-1"][class*="md:grid-cols-4"]');
            gridElements.forEach(function(element) {
                element.style.display = 'grid';
                element.style.gridTemplateColumns = 'repeat(2, 1fr)';
                element.style.gap = '0.75rem';
            });
            
            // 强制页面标题区域为垂直布局
            const titleAreas = document.querySelectorAll('.flex.items-center.justify-between.mb-6');
            titleAreas.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.alignItems = 'flex-start';
                element.style.gap = '1rem';
            });
            
            // 强制按钮组为垂直布局
            const buttonGroups = document.querySelectorAll('.flex.items-center.space-x-4');
            buttonGroups.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.gap = '0.5rem';
                element.style.width = '100%';
            });
        }
    }
    
    // 窗口大小变化时重新应用移动端布局
    window.addEventListener('resize', function() {
        setTimeout(forceMobileLayout, 100);
    });
    
    // 页面加载完成后执行
    setTimeout(forceMobileLayout, 500);
</script>

{% endblock %}