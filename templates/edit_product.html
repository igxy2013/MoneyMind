{% extends "base.html" %}

{% block title %}编辑商品 - 七彩果坊经营管理系统{% endblock %}


{% block extra_head %}
<!-- Tailwind CSS 已在 base.html 中引用 -->


<link href="{{ url_for('static', filename='css/remixicon.min.css') }}" rel="stylesheet">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 页面标题 -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">编辑商品</h1>
                <p class="text-gray-600">修改商品信息，包括基本信息、价格设置和图片管理</p>
            </div>
            <a href="{{ url_for('products') }}" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors flex items-center space-x-2">
                <div class="w-4 h-4 flex items-center justify-center">
                    <i class="ri-arrow-left-line"></i>
                </div>
                <span>返回列表</span>
            </a>
        </div>
    </div>

    <!-- 编辑表单 -->
    <div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 overflow-hidden">
        <form method="POST" enctype="multipart/form-data" class="p-8 space-y-8">
            <!-- 隐藏字段标记图片删除状态 -->
            <input type="hidden" id="removeImageFlag" name="remove_image" value="0">
            <!-- 商品图片 -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">商品图片</h4>
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl p-8 hover:border-primary transition-colors cursor-pointer" id="imageUploadArea">
                    <i class="ri-image-line text-3xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500 mb-2">点击上传或拖拽图片到此处</p>
                    <p class="text-xs text-gray-400">支持 JPG、PNG、GIF 格式，最大 5MB</p>
                    <input type="file" id="productImage" name="image" accept="image/*" class="hidden">
                </div>
                <!-- 图片预览区域 -->
                <div id="imagePreview" class="mt-4 {% if not product.image_path %}hidden{% endif %}">
                    <div class="text-sm text-gray-600 mb-2">图片预览：</div>
                    <div id="imagePreviewContainer" class="relative inline-block">
                        <img id="previewImage" src="{% if product.image_path %}/static/{{ product.image_path }}{% endif %}" alt="商品图片预览" class="w-32 h-32 object-cover rounded-lg border border-gray-200">
                        <button type="button" id="removeImage" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                            <i class="ri-close-line text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 基本信息 -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">基本信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">商品名称 *</label>
                        <input type="text" id="name" name="name" value="{{ product.name }}" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="请输入商品名称">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">商品分类</label>
                        <select id="category" name="category" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择分类</option>
                            <option value="fresh-fruit" {% if product.category == 'fresh-fruit' %}selected{% endif %}>新鲜水果</option>
                            <option value="dried-fruit" {% if product.category == 'dried-fruit' %}selected{% endif %}>干果坚果</option>
                            <option value="fruit-juice" {% if product.category == 'fruit-juice' %}selected{% endif %}>果汁饮品</option>
                            <option value="fruit-snack" {% if product.category == 'fruit-snack' %}selected{% endif %}>果脯零食</option>
                        </select>
                    </div>
                    <div>
                        <label for="supplier" class="block text-sm font-medium text-gray-700 mb-2">供应商</label>
                        <select id="supplier" name="supplier" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择供应商</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" {% if product.supplier_id == supplier.id %}selected{% endif %}>
                                {{ supplier.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="unit" class="block text-sm font-medium text-gray-700 mb-2">计量单位</label>
                        <select id="unit" name="unit" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择单位</option>
                            <option value="斤" {% if product.unit == '斤' %}selected{% endif %}>斤</option>
                            <option value="公斤" {% if product.unit == '公斤' %}selected{% endif %}>公斤</option>
                            <option value="个" {% if product.unit == '个' %}selected{% endif %}>个</option>
                            <option value="包" {% if product.unit == '包' %}selected{% endif %}>包</option>
                            <option value="盒" {% if product.unit == '盒' %}selected{% endif %}>盒</option>
                            <option value="瓶" {% if product.unit == '瓶' %}selected{% endif %}>瓶</option>
                            <option value="袋" {% if product.unit == '袋' %}selected{% endif %}>袋</option>
                            <option value="箱" {% if product.unit == '箱' %}selected{% endif %}>箱</option>
                            <option value="件" {% if product.unit == '件' %}selected{% endif %}>件</option>
                            <option value="其他" {% if product.unit == '其他' %}selected{% endif %}>其他</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 价格和库存 -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">价格和库存</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="cost_price" class="block text-sm font-medium text-gray-700 mb-2">成本价 (元)</label>
                        <input type="number" step="0.01" id="cost_price" name="cost_price" value="{{ product.cost_price or '' }}" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="0.00">
                    </div>
                    <div>
                        <label for="selling_price" class="block text-sm font-medium text-gray-700 mb-2">销售价 (元)</label>
                        <input type="number" step="0.01" id="selling_price" name="selling_price" value="{{ product.selling_price or '' }}" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="0.00">
                    </div>
                    <div>
                        <label for="stock" class="block text-sm font-medium text-gray-700 mb-2">库存数量</label>
                        <input type="number" id="stock" name="stock" value="{{ product.stock or 0 }}" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- 商品描述 -->
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">商品描述</h4>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">详细描述</label>
                    <textarea id="description" name="description" rows="3" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 resize-none" placeholder="请输入商品详细描述...">{{ product.description or '' }}</textarea>
                </div>
                <div class="mt-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %} class="w-4 h-4 text-primary rounded">
                        <span class="ml-2 text-sm text-gray-700">商品上架</span>
                    </label>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{{ url_for('products') }}" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</a>
                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存修改</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageUploadArea = document.getElementById('imageUploadArea');
    const productImage = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const removeImage = document.getElementById('removeImage');

    // 图片上传区域点击事件
    imageUploadArea.addEventListener('click', function() {
        productImage.click();
    });

    // 图片文件选择处理
    productImage.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }
            
            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片大小不能超过5MB');
                return;
            }
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                imagePreview.classList.remove('hidden');
                // 重置删除标记
                document.getElementById('removeImageFlag').value = '0';
            };
            reader.readAsDataURL(file);
        }
    });

    // 移除图片
    removeImage.addEventListener('click', function() {
        productImage.value = '';
        imagePreview.classList.add('hidden');
        // 标记图片需要删除
        document.getElementById('removeImageFlag').value = '1';
    });

    // 拖拽上传功能
    imageUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        imageUploadArea.classList.add('border-primary');
    });

    imageUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        imageUploadArea.classList.remove('border-primary');
    });

    imageUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        imageUploadArea.classList.remove('border-primary');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                productImage.files = files;
                productImage.dispatchEvent(new Event('change'));
            } else {
                alert('请选择图片文件');
            }
        }
    });
});
</script>
{% endblock %}