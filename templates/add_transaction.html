{% extends "base.html" %}

{% block title %}添加收支 - MoneyMind{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
<div class="mb-8">
<div class="flex items-center justify-between mb-8">
<div>
<div class="flex items-center space-x-3 mb-2">
<a href="{{ url_for('transactions') }}" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-arrow-left-line text-gray-600"></i>
</div>
</a>
<h1 class="text-3xl font-bold text-gray-900 mb-2">添加收支</h1>
</div>
<p class="text-gray-600">录入新的收入或支出记录，完善财务数据管理</p>
</div>
</div>

<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-8">
<form method="POST" id="incomeExpenseForm" class="space-y-8">
<div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
<h3 class="text-lg font-semibold text-gray-900 mb-6">基本信息</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-3">收支类型 <span class="text-red-500">*</span></label>
<div class="flex space-x-4">
<label class="flex items-center cursor-pointer">
<div class="relative">
<input type="radio" name="type" value="income" class="sr-only" {% if transaction_type == 'income' %}checked{% endif %} required>
<div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center transition-all duration-200 radio-custom">
<div class="w-2.5 h-2.5 bg-primary rounded-full opacity-0 transition-opacity duration-200 radio-dot"></div>
</div>
</div>
<span class="ml-3 text-gray-700 font-medium">收入</span>
</label>
<label class="flex items-center cursor-pointer">
<div class="relative">
<input type="radio" name="type" value="expense" class="sr-only" {% if transaction_type == 'expense' %}checked{% endif %} required>
<div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center transition-all duration-200 radio-custom">
<div class="w-2.5 h-2.5 bg-primary rounded-full opacity-0 transition-opacity duration-200 radio-dot"></div>
</div>
</div>
<span class="ml-3 text-gray-700 font-medium">支出</span>
</label>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">金额 <span class="text-red-500">*</span></label>
<div class="relative">
<span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">¥</span>
<input type="number" id="amount" name="amount" required step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 text-sm" placeholder="请输入金额">
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收支分类 <span class="text-red-500">*</span></label>
<div class="relative">
<select id="category" name="category" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 text-sm pr-10 appearance-none">
<option value="">请选择分类</option>
{% for category in categories %}
<option value="{{ category.id }}" data-type="{{ category.type }}">
{{ category.name }}
</option>
{% endfor %}
</select>
<div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-arrow-down-s-line text-gray-400"></i>
</div>
</div>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">交易日期 <span class="text-red-500">*</span></label>
<input type="date" id="date" name="date" value="{{ today }}" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 text-sm">
</div>

</div>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-2">备注说明</label>
<textarea id="description" name="description" rows="4" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900 text-sm resize-none" placeholder="请输入相关备注信息，如交易详情、用途说明等..."></textarea>
</div>

<div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
<a href="{{ url_for('transactions') }}" class="px-8 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors font-medium">取消</a>
<button type="submit" class="px-8 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors font-medium flex items-center space-x-2">
<div class="w-4 h-4 flex items-center justify-center">
<i class="ri-save-line"></i>
</div>
<span>保存收支记录</span>
</button>
</div>
</form>
</div>
</div>
</main>
</div>
</body>

<script>
// 自定义单选按钮样式
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // 重置所有单选按钮样式
        document.querySelectorAll('input[type="radio"][name="' + this.name + '"]').forEach(r => {
            const customRadio = r.parentElement.querySelector('.radio-custom');
            const radioDot = r.parentElement.querySelector('.radio-dot');
            customRadio.classList.remove('border-primary');
            radioDot.classList.remove('opacity-100');
            radioDot.classList.add('opacity-0');
        });
        
        // 设置选中的单选按钮样式
        if (this.checked) {
            const customRadio = this.parentElement.querySelector('.radio-custom');
            const radioDot = this.parentElement.querySelector('.radio-dot');
            customRadio.classList.add('border-primary');
            radioDot.classList.remove('opacity-0');
            radioDot.classList.add('opacity-100');
        }
    });
    
    // 初始化已选中的单选按钮
    if (radio.checked) {
        radio.dispatchEvent(new Event('change'));
    }
});

// 存储所有分类选项的原始数据
let allCategoryOptions = [];

// 根据交易类型过滤分类
function filterCategories() {
    const typeRadios = document.querySelectorAll('input[name="type"]');
    let selectedType = '';
    
    typeRadios.forEach(radio => {
        if (radio.checked) {
            selectedType = radio.value;
        }
    });
    
    const categorySelect = document.getElementById('category');
    
    // 如果还没有保存原始选项，先保存
    if (allCategoryOptions.length === 0) {
        const options = categorySelect.querySelectorAll('option');
        options.forEach(option => {
            allCategoryOptions.push({
                value: option.value,
                text: option.textContent,
                type: option.getAttribute('data-type')
            });
        });
    }
    
    // 清空现有选项
    categorySelect.innerHTML = '';
    
    // 添加默认选项
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '请选择分类';
    categorySelect.appendChild(defaultOption);
    
    // 根据选中的类型添加对应的分类选项
    allCategoryOptions.forEach(optionData => {
        if (optionData.value === '') {
            return; // 跳过默认选项，已经添加过了
        }
        
        if (selectedType === '' || optionData.type === selectedType) {
            const newOption = document.createElement('option');
            newOption.value = optionData.value;
            newOption.textContent = optionData.text;
            newOption.setAttribute('data-type', optionData.type);
            categorySelect.appendChild(newOption);
        }
    });
    
    // 重置分类选择
    categorySelect.value = '';
}

// 交易类型变化时过滤分类
document.querySelectorAll('input[name="type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // 过滤分类
        filterCategories();
    });
});

// 表单验证
document.getElementById('incomeExpenseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const amount = parseFloat(formData.get('amount'));
    const transactionType = formData.get('type');
    const category = formData.get('category');

    
    if (!transactionType) {
        alert('请选择收支类型');
        return;
    }
    
    if (!amount || amount <= 0) {
        alert('请输入有效的金额');
        return;
    }
    
    if (!category) {
        alert('请选择收支分类');
        return;
    }
    

    
    // 如果验证通过，提交表单
    this.submit();
});

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 设置默认日期为今天
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    
    // 初始化分类过滤
    filterCategories();
    
    // 初始化单选按钮样式
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        radio.dispatchEvent(new Event('change'));
    });
});
</script>
{% endblock %}