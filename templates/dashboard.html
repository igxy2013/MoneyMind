{% extends "base.html" %}

{% block title %}仪表板 - 七彩果坊经营管理系统{% endblock %}


{% block extra_head %}
<link href="{{ url_for('static', filename='css/remixicon.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/mobile.css') }}" rel="stylesheet">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }

/* 移动端仪表板优化 */
@media (max-width: 768px) {
    /* 头部区域优化 */
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .dashboard-header .flex {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    /* 按钮组优化 */
    .button-group {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
        width: 100%;
    }
    
    .button-group > div {
        width: 100%;
        display: flex;
        justify-content: center;
    }
    
    .button-group .bg-white\/60 {
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
    }
    
    .button-group a {
        width: 100%;
        max-width: 200px;
        margin: 0 auto;
        justify-content: center;
    }
    
    /* 统计卡片优化 */
    .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .stat-card {
        padding: 1rem;
    }
    
    .stat-card .text-2xl {
        font-size: 1.5rem;
    }
    
    /* 图表区域优化 */
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .chart-container {
        padding: 1rem;
    }
    
    .chart-container h3 {
        font-size: 1rem;
    }
    
    /* 表格优化 */
    .table-container {
        padding: 1rem;
    }
    
    .mobile-table {
        display: block;
    }
    
    .desktop-table {
        display: none;
    }
    
    .transaction-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .transaction-amount {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .transaction-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
}

@media (min-width: 769px) {
    .mobile-table {
        display: none;
    }
    
    .desktop-table {
        display: block;
    }
}
</style>
{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-2 sm:px-4">
<div class="dashboard-header mb-8">
<div class="flex items-start justify-between mb-2">
<div>
<h1 class="text-3xl font-bold text-gray-900 mb-2 text-left">仪表板</h1>
<p class="text-gray-600 text-sm sm:text-base mt-1">经营数据概览与分析</p>

</div>
<div class="button-group flex items-center justify-end ml-auto bg-gray-100 rounded-xl">
<button class="px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white bg-primary rounded-button transition-colors whitespace-nowrap" id="monthBtn">本月</button>
<button class="px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-600  transition-colors whitespace-nowrap rounded-button" id="yearBtn">本年</button>
</div>
</div>
</div>
</div>
<div class="stats-grid grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
<div class="stat-card bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4">
<div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-arrow-up-line text-green-600 text-xl"></i>
</div>
</div>
<div class="text-right">
<div class="text-sm text-gray-500">同比上月</div>
<div class="text-green-600 font-semibold">+12.5%</div>
</div>
</div>
<div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "%.2f"|format(month_income) }}</div>
<div class="text-gray-600 text-sm">本月收入总额</div>
</div>

<div class="stat-card bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4">
<div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-arrow-down-line text-red-600 text-xl"></i>
</div>
</div>
<div class="text-right">
<div class="text-sm text-gray-500">同比上月</div>
<div class="text-red-600 font-semibold">+8.3%</div>
</div>
</div>
<div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "%.2f"|format(month_expense) }}</div>
<div class="text-gray-600 text-sm">本月支出总额</div>
</div>

<div class="stat-card bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4">
<div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-trending-up-line text-blue-600 text-xl"></i>
</div>
</div>
<div class="text-right">
<div class="text-sm text-gray-500">同比上月</div>
<div class="text-green-600 font-semibold">+18.7%</div>
</div>
</div>
<div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "%.2f"|format(month_income - month_expense) }}</div>
<div class="text-gray-600 text-sm">本月利润</div>
</div>

<div class="stat-card bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4">
<div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
<div class="w-6 h-6 flex items-center justify-center">
<i class="ri-wallet-line text-purple-600 text-xl"></i>
</div>
</div>
<div class="text-right">
<div class="text-sm text-gray-500">现金流</div>
<div class="text-green-600 font-semibold">健康</div>
</div>
</div>
<div class="text-2xl font-bold text-gray-900 mb-1">¥{{ "%.2f"|format(cash_balance) }}</div>
<div class="text-gray-600 text-sm">现金余额</div>
</div>
</div>
<div class="charts-grid grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
<div class="chart-container bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4 sm:mb-6">
<h3 class="text-base sm:text-lg font-semibold text-gray-900">收支趋势</h3>
<div class="flex items-center bg-gray-100 rounded-xl px-1 py-1">
<button class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium text-white bg-primary rounded-button transition-colors whitespace-nowrap" id="trendMonthBtn">月度</button>
<button class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium text-gray-600  transition-colors whitespace-nowrap rounded-button" id="trendYearBtn">年度</button>
</div>
</div>
<div id="trendChart" class="h-64 sm:h-80"></div>
</div>

<div class="chart-container bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6">
<div class="flex items-center justify-between mb-4 sm:mb-6">
<h3 class="text-base sm:text-lg font-semibold text-gray-900">收支构成</h3>
<div class="flex items-center bg-gray-100 rounded-xl px-1 py-1">
<button class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium text-white bg-primary rounded-button transition-colors whitespace-nowrap" id="pieIncomeBtn">收入</button>
<button class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium text-gray-600  transition-colors whitespace-nowrap rounded-button" id="pieExpenseBtn">支出</button>
</div>
</div>
<div id="pieChart" class="h-64 sm:h-80"></div>
</div>
</div>

<!-- 交易记录表格 -->
<div class="table-container bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-4 sm:p-6 mb-6 sm:mb-8">
<div class="flex items-center justify-between mb-4 sm:mb-6">
<h3 class="text-base sm:text-lg font-semibold text-gray-900">最近交易记录</h3>
<a href="{{ url_for('add_transaction') }}" class="px-3 sm:px-4 py-2 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors text-xs sm:text-sm font-medium">添加收支</a>
</div>

<!-- 桌面端表格 -->
<div class="desktop-table overflow-x-auto">
<table class="w-full">
<thead>
<tr class="border-b border-gray-200">
<th class="text-left py-3 px-4 font-medium text-gray-700">交易日期</th>
<th class="text-left py-3 px-4 font-medium text-gray-700">交易类型</th>
<th class="text-left py-3 px-4 font-medium text-gray-700">分类</th>
<th class="text-right py-3 px-4 font-medium text-gray-700">金额</th>
<th class="text-left py-3 px-4 font-medium text-gray-700">备注信息</th>
</tr>
</thead>
<tbody>
{% for transaction in recent_transactions %}
<tr class="border-b border-gray-100 hover:bg-gray-50/50">
<td class="py-3 px-4 text-gray-900">{{ transaction.date.strftime('%Y-%m-%d') }}</td>
<td class="py-3 px-4">
{% if transaction.type == 'income' %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">收入</span>
{% else %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">支出</span>
{% endif %}
</td>
<td class="py-3 px-4 text-gray-700">{{ transaction.category.name if transaction.category else '-' }}</td>
<td class="py-3 px-4 text-right font-medium {% if transaction.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
{% if transaction.type == 'income' %}+{% else %}-{% endif %}¥{{ "%.2f"|format(transaction.amount) }}
</td>
<td class="py-3 px-4 text-gray-700">{{ transaction.description or '-' }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- 移动端卡片布局 -->
<div class="mobile-table">
{% for transaction in recent_transactions %}
<div class="transaction-card">
<div class="transaction-header">
<div class="flex items-center space-x-2">
{% if transaction.type == 'income' %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">收入</span>
{% else %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">支出</span>
{% endif %}
<span class="text-sm text-gray-600">{{ transaction.date.strftime('%m-%d') }}</span>
</div>
<div class="transaction-amount {% if transaction.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
{% if transaction.type == 'income' %}+{% else %}-{% endif %}¥{{ "%.2f"|format(transaction.amount) }}
</div>
</div>
<div class="transaction-details">
<div>
<span class="text-gray-500">分类:</span>
<span>{{ transaction.category.name if transaction.category else '-' }}</span>
</div>
<div>
<span class="text-gray-500">支付:</span>
<span>{{ transaction.payment_method or '-' }}</span>
</div>
<div class="col-span-2">
<span class="text-gray-500">备注:</span>
<span>{{ transaction.description or '-' }}</span>
</div>
</div>
</div>
{% endfor %}
</div>

<div class="flex items-center justify-between mt-4 sm:mt-6 pt-4 border-t border-gray-200">
<div class="text-xs sm:text-sm text-gray-600">显示最近 {{ recent_transactions|length }} 条交易记录</div>
<div class="flex items-center space-x-2">
<a href="{{ url_for('transactions') }}" class="px-3 py-2 text-xs sm:text-sm text-gray-600 hover:text-primary transition-colors whitespace-nowrap rounded-button">查看全部</a>
</div>
</div>
</div>

<script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
<script id="period-toggle-script">
document.addEventListener('DOMContentLoaded', function() {
const monthBtn = document.getElementById('monthBtn');
const yearBtn = document.getElementById('yearBtn');

// 数据定义
const monthData = {
    income: {{ month_income }},
    expense: {{ month_expense }},
    profit: {{ month_income - month_expense }}
};

const yearData = {
    income: {{ year_income }},
    expense: {{ year_expense }},
    profit: {{ year_income - year_expense }}
};

function updateStatCards(data, period) {
     // 更新收入卡片
     const cards = document.querySelectorAll('.grid .bg-white\\/60');
     const incomeCard = cards[0];
     const incomeAmount = incomeCard.querySelector('.text-2xl');
     const incomeLabel = incomeCard.querySelector('.text-gray-600');
     incomeAmount.textContent = '¥' + data.income.toFixed(2);
     incomeLabel.textContent = period + '收入总额';
     
     // 更新支出卡片
     const expenseCard = cards[1];
     const expenseAmount = expenseCard.querySelector('.text-2xl');
     const expenseLabel = expenseCard.querySelector('.text-gray-600');
     expenseAmount.textContent = '¥' + data.expense.toFixed(2);
     expenseLabel.textContent = period + '支出总额';
     
     // 更新利润卡片
     const profitCard = cards[2];
     const profitAmount = profitCard.querySelector('.text-2xl');
     const profitLabel = profitCard.querySelector('.text-gray-600');
     profitAmount.textContent = '¥' + data.profit.toFixed(2);
     profitLabel.textContent = period + '利润';
 }

function togglePeriod(activeBtn, inactiveBtn) {
    activeBtn.classList.add('bg-primary', 'text-white');
    activeBtn.classList.remove('text-gray-600');
    inactiveBtn.classList.remove('bg-primary', 'text-white');
    inactiveBtn.classList.add('text-gray-600');
    
    // 根据按钮更新数据
    if (activeBtn.id === 'monthBtn') {
        updateStatCards(monthData, '本月');
        // 更新饼图数据为月度数据
        window.currentPeriod = 'month';
        if (window.updatePieChartForPeriod) {
            window.updatePieChartForPeriod('month');
        }
    } else {
        updateStatCards(yearData, '本年');
        // 更新饼图数据为年度数据
        window.currentPeriod = 'year';
        if (window.updatePieChartForPeriod) {
            window.updatePieChartForPeriod('year');
        }
    }
}

monthBtn.addEventListener('click', () => togglePeriod(monthBtn, yearBtn));
yearBtn.addEventListener('click', () => togglePeriod(yearBtn, monthBtn));

// 初始化为月度数据
window.currentPeriod = 'month';
});
</script>

<script id="trend-chart-script">
document.addEventListener('DOMContentLoaded', function() {
const trendChart = echarts.init(document.getElementById('trendChart'));
const trendMonthBtn = document.getElementById('trendMonthBtn');
const trendYearBtn = document.getElementById('trendYearBtn');

const monthData = {
xAxis: [{% for data in trend_data %}'{{ data.month }}'{% if not loop.last %}, {% endif %}{% endfor %}],
income: [{% for data in trend_data %}{{ data.income }}{% if not loop.last %}, {% endif %}{% endfor %}],
expense: [{% for data in trend_data %}{{ data.expense }}{% if not loop.last %}, {% endif %}{% endfor %}]
};

const yearData = {
xAxis: [{% for data in year_data %}'{{ data.year }}'{% if not loop.last %}, {% endif %}{% endfor %}],
income: [{% for data in year_data %}{{ data.income }}{% if not loop.last %}, {% endif %}{% endfor %}],
expense: [{% for data in year_data %}{{ data.expense }}{% if not loop.last %}, {% endif %}{% endfor %}]
};

function updateTrendChart(data) {
const option = {
animation: false,
grid: { top: 20, right: 20, bottom: 40, left: 60 },
xAxis: {
type: 'category',
data: data.xAxis,
axisLine: { lineStyle: { color: '#e5e7eb' } },
axisLabel: { color: '#6b7280' }
},
yAxis: {
type: 'value',
axisLine: { show: false },
axisTick: { show: false },
axisLabel: { color: '#6b7280' },
splitLine: { lineStyle: { color: '#f3f4f6' } }
},
tooltip: {
trigger: 'axis',
backgroundColor: 'rgba(255, 255, 255, 0.95)',
borderColor: '#e5e7eb',
textStyle: { color: '#1f2937' },
formatter: function(params) {
let result = params[0].name + '<br/>';
params.forEach(function(item) {
result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2) + '<br/>';
});
return result;
}
},
series: [
{
name: '收入',
type: 'line',
data: data.income,
smooth: true,
symbol: 'none',
lineStyle: { color: 'rgba(87, 181, 231, 1)', width: 3 },
areaStyle: {
color: {
type: 'linear',
x: 0, y: 0, x2: 0, y2: 1,
colorStops: [
{ offset: 0, color: 'rgba(87, 181, 231, 0.1)' },
{ offset: 1, color: 'rgba(87, 181, 231, 0.01)' }
]
}
}
},
{
name: '支出',
type: 'line',
data: data.expense,
smooth: true,
symbol: 'none',
lineStyle: { color: 'rgba(252, 141, 98, 1)', width: 3 },
areaStyle: {
color: {
type: 'linear',
x: 0, y: 0, x2: 0, y2: 1,
colorStops: [
{ offset: 0, color: 'rgba(252, 141, 98, 0.1)' },
{ offset: 1, color: 'rgba(252, 141, 98, 0.01)' }
]
}
}
}
]
};
trendChart.setOption(option);
}

function toggleTrendPeriod(activeBtn, inactiveBtn, data) {
activeBtn.classList.add('bg-primary', 'text-white');
activeBtn.classList.remove('text-gray-600');
inactiveBtn.classList.remove('bg-primary', 'text-white');
inactiveBtn.classList.add('text-gray-600');
updateTrendChart(data);
}

trendMonthBtn.addEventListener('click', () => toggleTrendPeriod(trendMonthBtn, trendYearBtn, monthData));
trendYearBtn.addEventListener('click', () => toggleTrendPeriod(trendYearBtn, trendMonthBtn, yearData));

updateTrendChart(monthData);

// 响应式图表调整
window.addEventListener('resize', function() {
    if (trendChart) {
        trendChart.resize();
    }
});
});
</script>

<script id="pie-chart-script">
document.addEventListener('DOMContentLoaded', function() {
const pieChart = echarts.init(document.getElementById('pieChart'));
const pieIncomeBtn = document.getElementById('pieIncomeBtn');
const pieExpenseBtn = document.getElementById('pieExpenseBtn');

// 月度数据
const monthIncomeData = [
{% for stat in income_category_stats %}
{ value: {{ stat.total }}, name: '{{ stat.name }}' }{% if not loop.last %},{% endif %}
{% endfor %}
{% if not income_category_stats %}
{ value: 0, name: '暂无收入数据' }
{% endif %}
];

const monthExpenseData = [
{% for stat in expense_category_stats %}
{ value: {{ stat.total }}, name: '{{ stat.name }}' }{% if not loop.last %},{% endif %}
{% endfor %}
{% if not expense_category_stats %}
{ value: 0, name: '暂无支出数据' }
{% endif %}
];

// 年度数据
const yearIncomeData = [
{% for stat in year_income_category_stats %}
{ value: {{ stat.total }}, name: '{{ stat.name }}' }{% if not loop.last %},{% endif %}
{% endfor %}
{% if not year_income_category_stats %}
{ value: 0, name: '暂无收入数据' }
{% endif %}
];

const yearExpenseData = [
{% for stat in year_expense_category_stats %}
{ value: {{ stat.total }}, name: '{{ stat.name }}' }{% if not loop.last %},{% endif %}
{% endfor %}
{% if not year_expense_category_stats %}
{ value: 0, name: '暂无支出数据' }
{% endif %}
];

// 当前显示的数据类型
let currentType = 'income';
let currentPeriod = 'month';

function updatePieChart(data) {
const option = {
animation: false,
tooltip: {
trigger: 'item',
backgroundColor: 'rgba(255, 255, 255, 0.95)',
borderColor: '#e5e7eb',
textStyle: { color: '#1f2937' },
formatter: function(params) {
return params.seriesName + '<br/>' + params.name + ': ¥' + params.value.toFixed(2) + ' (' + params.percent.toFixed(1) + '%)';
}
},
series: [
{
name: '金额分布',
type: 'pie',
radius: ['40%', '70%'],
center: ['50%', '50%'],
data: data,
itemStyle: {
borderRadius: 8,
borderColor: '#fff',
borderWidth: 2
},
label: {
show: true,
formatter: function(params) {
return params.name + '\n¥' + params.value.toFixed(2);
},
color: '#1f2937'
},
labelLine: {
show: true
},
color: ['rgba(87, 181, 231, 1)', 'rgba(141, 211, 199, 1)', 'rgba(251, 191, 114, 1)', 'rgba(252, 141, 98, 1)']
}
]
};
pieChart.setOption(option);
}

// 获取当前应显示的数据
function getCurrentData(type, period) {
    if (type === 'income') {
        return period === 'month' ? monthIncomeData : yearIncomeData;
    } else {
        return period === 'month' ? monthExpenseData : yearExpenseData;
    }
}

function togglePieType(activeBtn, inactiveBtn, type) {
    activeBtn.classList.add('bg-primary', 'text-white');
    activeBtn.classList.remove('text-gray-600');
    inactiveBtn.classList.remove('bg-primary', 'text-white');
    inactiveBtn.classList.add('text-gray-600');
    
    currentType = type;
    const data = getCurrentData(currentType, currentPeriod);
    updatePieChart(data);
}

// 全局函数，供期间切换调用
window.updatePieChartForPeriod = function(period) {
    currentPeriod = period;
    const data = getCurrentData(currentType, currentPeriod);
    updatePieChart(data);
};

pieIncomeBtn.addEventListener('click', () => togglePieType(pieIncomeBtn, pieExpenseBtn, 'income'));
pieExpenseBtn.addEventListener('click', () => togglePieType(pieExpenseBtn, pieIncomeBtn, 'expense'));

// 初始化显示收入数据
const initialData = getCurrentData('income', 'month');
updatePieChart(initialData);

// 响应式图表调整
window.addEventListener('resize', function() {
    if (pieChart) {
        pieChart.resize();
    }
});
});
</script>

{% endblock %}