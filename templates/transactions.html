{% extends "base.html" %}

{% block title %}收支记录 - 七彩果坊经营管理系统{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8 transactions-container{% if current_user.role == 'employee' %} employee-role{% endif %}">

<!-- 页面标题 -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">收支记录</h1>
        <p class="text-gray-600">查看和管理所有交易记录</p>
    </div>
    <div class="flex items-center space-x-4">
        <div class="relative" id="exportDropdown">
            <button class="px-4 py-2 {% if transactions.total > 0 %}text-gray-600 hover:text-primary{% else %}text-gray-400 cursor-not-allowed{% endif %} transition-colors flex items-center space-x-2" id="exportBtn" {% if transactions.total == 0 %}disabled{% endif %}>
                <div class="w-4 h-4 flex items-center justify-center">
                    <i class="fas fa-download"></i>
                </div>
                <span>导出</span>
                 {% if transactions.total > 0 %}
                 <span class="text-xs text-gray-500 ml-1">({{ transactions.total }}条)</span>
                 {% endif %}
                 <div class="w-4 h-4 flex items-center justify-center ml-1">
                     <i class="fas fa-chevron-down text-xs"></i>
                 </div>
            </button>
            <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 z-50 hidden" id="exportMenu">
                <div class="py-2">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2" data-format="csv">
                        <i class="fas fa-file-csv text-green-600"></i>
                        <span>导出为 CSV</span>
                    </button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2" data-format="excel">
                        <i class="fas fa-file-excel text-green-600"></i>
                        <span>导出为 Excel</span>
                    </button>
                </div>
            </div>
        </div>
        {% if current_user.role != 'employee' %}
        <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium flex items-center space-x-2" id="addTransactionBtn">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-plus"></i>
            </div>
            <span>添加收支</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- 筛选区域 -->
<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6 mb-6">
    <form id="filterForm" method="GET">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">日期范围</label>
                <div class="flex items-center space-x-2">
                    <input type="date" id="startDate" name="start_date" value="{{ filter_params.start_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <span class="text-gray-400">至</span>
                    <input type="date" id="endDate" name="end_date" value="{{ filter_params.end_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">交易类型</label>
                <select id="typeFilter" name="type" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部类型</option>
                    <option value="income" {{ 'selected' if filter_params.type == 'income' else '' }}>收入</option>
                    <option value="expense" {{ 'selected' if filter_params.type == 'expense' else '' }}>支出</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                <select id="categoryFilter" name="category_id" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部分类</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {{ 'selected' if filter_params.category_id == category.id|string else '' }}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button type="submit" id="filterBtn" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors text-sm font-medium">
                    筛选
                </button>
                <button type="button" id="resetBtn" class="px-4 py-2 text-gray-600 hover:text-primary transition-colors text-sm">
                    重置
                </button>
            </div>
            <div class="text-sm text-gray-600">
                共找到 <span class="font-medium text-primary">{{ transactions.total }}</span> 条记录
            </div>
        </div>
    </form>
</div>

<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6">
        {% if transactions.items %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-medium text-gray-700">交易日期</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">交易类型</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">分类</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">金额</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">备注信息</th>

                            {% if current_user.role != 'employee' %}
                            <th class="text-left py-3 px-4 font-medium text-gray-700">操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions.items %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                            <td class="py-3 px-4 text-gray-900">{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if transaction.type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ '收入' if transaction.type == 'income' else '支出' }}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-gray-700">{{ transaction.category.name }}</td>
                            <td class="py-3 px-4 text-right font-medium {% if transaction.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ '+' if transaction.type == 'income' else '-' }}¥{{ "%.2f"|format(transaction.amount) }}
                            </td>
                            <td class="py-3 px-4 text-gray-700">
                                {{ transaction.description or '-' }}
                            </td>

                            {% if current_user.role != 'employee' %}
                            <td class="py-3 px-4">
                                <div class="flex items-center space-x-2">
                                    <a href="{{ url_for('edit_transaction', id=transaction.id) }}" 
                                       class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-blue-500 transition-colors" 
                                       title="编辑">
                                        <div class="w-4 h-4 flex items-center justify-center">
                                            <i class="ri-edit-line"></i>
                                        </div>
                                    </a>
                                    <button onclick="deleteTransaction({{ transaction.id }})" 
                                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors" 
                                            title="删除">
                                        <div class="w-4 h-4 flex items-center justify-center">
                                            <i class="ri-delete-bin-line"></i>
                                        </div>
                                    </button>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    {% if transactions.pages > 1 %}
                    <div class="text-sm text-gray-600">显示 {{ (transactions.page - 1) * transactions.per_page + 1 }}-{{ transactions.page * transactions.per_page if transactions.page * transactions.per_page < transactions.total else transactions.total }} 条，共 {{ transactions.total }} 条记录</div>
                    {% endif %}
                </div>
                {% if transactions.pages > 1 %}
                <div class="flex items-center space-x-2">
                    {% if transactions.has_prev %}
                        <a href="{{ url_for('transactions', page=transactions.prev_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            上一页
                        </a>
                    {% endif %}
                    
                    {% for page_num in transactions.iter_pages() %}
                        {% if page_num %}
                            <a href="{{ url_for('transactions', page=page_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                               class="px-3 py-2 text-sm {% if page_num == transactions.page %}bg-primary text-white rounded-xl{% else %}text-gray-600 hover:text-primary transition-colors{% endif %}">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="px-3 py-2 text-sm text-gray-400">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if transactions.has_next %}
                        <a href="{{ url_for('transactions', page=transactions.next_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            下一页
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-inbox text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">暂无交易记录</h3>
                <p class="text-gray-600 mb-8">开始记录您的第一笔交易，建立完整的财务档案</p>
                {% if current_user.role != 'employee' %}
                <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors flex items-center justify-center mx-auto w-fit font-medium">
                    <i class="fas fa-plus mr-2"></i>添加第一笔交易
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    // 筛选功能
    const filterForm = document.getElementById('filterForm');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    // 重置筛选
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // 清空所有筛选字段
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            
            // 重新加载页面（不带筛选参数）
            window.location.href = window.location.pathname;
        });
    }
    
    // 导出功能
    const exportDropdown = document.getElementById('exportDropdown');
    const exportMenu = document.getElementById('exportMenu');
    
    if (exportBtn && exportDropdown && exportMenu) {
        // 切换下拉菜单显示
        exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            // 如果按钮被禁用，不执行任何操作
            if (exportBtn.disabled) {
                return;
            }
            exportMenu.classList.toggle('hidden');
        });
        
        // 点击其他地方关闭下拉菜单
        document.addEventListener('click', function() {
            exportMenu.classList.add('hidden');
        });
        
        // 阻止下拉菜单内部点击事件冒泡
        exportMenu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 处理导出格式选择
        const exportFormatBtns = exportMenu.querySelectorAll('[data-format]');
        exportFormatBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const format = this.getAttribute('data-format');
                exportTransactions(format);
                exportMenu.classList.add('hidden');
            });
        });
    }
    
    // 导出函数
    function exportTransactions(format) {
        // 获取当前筛选参数
        const params = new URLSearchParams(window.location.search);
        params.set('format', format);
        
        // 构建导出URL
        const exportUrl = '/export_transactions?' + params.toString();
        
        console.log('开始导出，格式:', format, '参数:', params.toString());
        
        // 使用fetch检查响应，然后触发下载
        fetch(exportUrl)
            .then(response => {
                console.log('导出响应状态:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error('导出失败: ' + response.status + ' ' + response.statusText);
                }
                return response.blob();
            })
            .then(blob => {
                console.log('导出文件大小:', blob.size, 'bytes');
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
                const extension = format === 'csv' ? 'csv' : 'xlsx';
                link.download = `收支记录_${timestamp}.${extension}`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                 console.log('文件下载已触发');
                 
                 // 恢复按钮状态并显示成功提示
                 exportBtn.innerHTML = originalText;
                 exportBtn.disabled = false;
                 
                 // 显示成功提示
                 const successMsg = document.createElement('div');
                 successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 max-w-sm';
                 successMsg.innerHTML = `
                     <div class="flex items-start">
                         <i class="fas fa-check mr-2 mt-0.5"></i>
                         <div>
                             <div class="font-medium">${formatText}文件导出成功！</div>
                         </div>
                     </div>
                 `;
                 document.body.appendChild(successMsg);
                 
                 // 3秒后移除提示
                 setTimeout(() => {
                     if (successMsg.parentNode) {
                         successMsg.parentNode.removeChild(successMsg);
                     }
                 }, 3000);
             })
             .catch(error => {
                 console.error('导出错误:', error);
                 // 恢复按钮状态
                 exportBtn.innerHTML = originalText;
                 exportBtn.disabled = false;
                 
                 // 显示错误提示
                 const errorMsg = document.createElement('div');
                 errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 max-w-sm';
                 errorMsg.innerHTML = `
                     <div class="flex items-start">
                         <i class="fas fa-exclamation-triangle mr-2 mt-0.5"></i>
                         <div>
                             <div class="font-medium">导出失败</div>
                             <div class="text-sm text-red-100 mt-1">${error.message}</div>
                         </div>
                     </div>
                 `;
                 document.body.appendChild(errorMsg);
                 
                 // 5秒后移除错误提示
                 setTimeout(() => {
                     if (errorMsg.parentNode) {
                         errorMsg.parentNode.removeChild(errorMsg);
                     }
                 }, 5000);
             });
        
        // 显示导出提示
        const originalText = exportBtn.innerHTML;
        const formatText = format === 'csv' ? 'CSV' : 'Excel';
        exportBtn.innerHTML = `<div class="w-4 h-4 flex items-center justify-center"><i class="fas fa-spinner fa-spin"></i></div><span>导出${formatText}中...</span>`;
        exportBtn.disabled = true;
    }
    
    // 移动端布局强制函数
    function forceMobileLayout() {
        if (window.innerWidth <= 768) {
            // 强制页面标题区域为垂直布局
            const titleAreas = document.querySelectorAll('.flex.items-center.justify-between.mb-8');
            titleAreas.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.alignItems = 'flex-start';
                element.style.gap = '1rem';
            });
            
            // 强制筛选区域为单列布局
            const gridElements = document.querySelectorAll('.grid.grid-cols-1.md\\:grid-cols-3');
            gridElements.forEach(function(element) {
                element.style.gridTemplateColumns = '1fr';
                element.style.gap = '1rem';
            });
            
            // 强制按钮组为垂直布局
            const buttonGroups = document.querySelectorAll('.flex.items-center.space-x-4');
            buttonGroups.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.gap = '0.5rem';
                element.style.width = '100%';
            });
        }
    }
    
    // 移动端表格优化
    if (window.innerWidth < 768) {
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                // 在移动端点击行时显示详细信息
                const cells = this.querySelectorAll('td');
                if (cells.length > 0) {
                    // 根据用户角色调整单元格索引
                    const isEmployee = {{ 'true' if current_user.role == 'employee' else 'false' }};
                    const dateIndex = isEmployee ? 0 : 1;
                    const typeIndex = isEmployee ? 1 : 2;
                    const categoryIndex = isEmployee ? 2 : 3;
                    const amountIndex = isEmployee ? 3 : 4;
                    
                    const date = cells[dateIndex] ? cells[dateIndex].textContent.trim() : '';
                    const type = cells[typeIndex] ? cells[typeIndex].textContent.trim() : '';
                    const category = cells[categoryIndex] ? cells[categoryIndex].textContent.trim() : '';
                    const amount = cells[amountIndex] ? cells[amountIndex].textContent.trim() : '';
                    
                    if (window.MobileUtils) {
                        window.MobileUtils.showMobileHint(`${date}\n${type} - ${category}\n${amount}`, 2000);
                    }
                }
            });
        });
        
        // 执行移动端布局强制
        forceMobileLayout();
    }
    
    // 窗口大小变化时重新应用移动端布局
    window.addEventListener('resize', function() {
        setTimeout(forceMobileLayout, 100);
    });
    
    // 页面加载完成后执行
    setTimeout(forceMobileLayout, 500);
    
    // 初始化批量选择功能
    initBatchSelection();
    

});





// 批量选择功能
function initBatchSelection() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const selectedCountElement = document.getElementById('selectedCount');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    
    if (!selectAllCheckbox || !selectedCountElement || !batchDeleteBtn) return;
    
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = checkedBoxes.length;
        selectedCountElement.textContent = `已选择 ${count} 项`;
        batchDeleteBtn.disabled = count === 0;
        
        // 更新全选复选框状态
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === transactionCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectedCount();
    });
    
    // 单个复选框变化
    transactionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

// 批量删除功能
function batchDeleteTransactions() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    const transactionIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));
    
    if (transactionIds.length === 0) {
        alert('请选择要删除的交易记录');
        return;
    }
    
    if (confirm(`确定要删除选中的 ${transactionIds.length} 条交易记录吗？此操作不可撤销。`)) {
        // 逐个删除选中的交易记录
        let deletedCount = 0;
        const totalCount = transactionIds.length;
        
        transactionIds.forEach((id, index) => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_transaction/${id}`;
            form.style.display = 'none';
            
            // 添加CSRF token（如果需要）
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            
            // 只在最后一个表单提交时刷新页面
            if (index === totalCount - 1) {
                form.submit();
            } else {
                // 对于其他表单，使用fetch异步提交
                const formData = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                }).then(() => {
                    deletedCount++;
                    if (deletedCount === totalCount - 1) {
                        // 所有异步删除完成后，提交最后一个表单刷新页面
                        const lastForm = document.createElement('form');
                        lastForm.method = 'POST';
                        lastForm.action = `/delete_transaction/${transactionIds[totalCount - 1]}`;
                        lastForm.style.display = 'none';
                        if (csrfToken) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = 'csrf_token';
                            csrfInput.value = csrfToken.getAttribute('content');
                            lastForm.appendChild(csrfInput);
                        }
                        document.body.appendChild(lastForm);
                        lastForm.submit();
                    }
                });
                document.body.removeChild(form);
            }
        });
    }
}

// 删除交易记录函数
function deleteTransaction(transactionId) {
    if (confirm('确定要删除这条交易记录吗？此操作不可撤销。')) {
        // 创建一个隐藏的表单来提交删除请求
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_transaction/${transactionId}`;
        form.style.display = 'none';
        
        // 添加CSRF token（如果需要）
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</div>
{% endblock %}