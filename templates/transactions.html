{% extends "base.html" %}

{% block title %}收支记录 - 七彩果坊{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8 transactions-container">

<!-- 页面标题 -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">收支记录</h1>
        <p class="text-gray-600">查看和管理所有交易记录</p>
    </div>
    <div class="flex items-center space-x-4">
        <button class="px-4 py-2 text-gray-600 hover:text-primary transition-colors flex items-center space-x-2" id="exportBtn">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-download"></i>
            </div>
            <span>导出</span>
        </button>
        {% if current_user.role != 'employee' %}
        <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors font-medium flex items-center space-x-2" id="addTransactionBtn">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-plus"></i>
            </div>
            <span>添加收支</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- 筛选区域 -->
<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6 mb-6">
    <form id="filterForm" method="GET">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">日期范围</label>
                <div class="flex items-center space-x-2">
                    <input type="date" id="startDate" name="start_date" value="{{ filter_params.start_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <span class="text-gray-400">至</span>
                    <input type="date" id="endDate" name="end_date" value="{{ filter_params.end_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">交易类型</label>
                <select id="typeFilter" name="type" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部类型</option>
                    <option value="income" {{ 'selected' if filter_params.type == 'income' else '' }}>收入</option>
                    <option value="expense" {{ 'selected' if filter_params.type == 'expense' else '' }}>支出</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                <select id="categoryFilter" name="category_id" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部分类</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {{ 'selected' if filter_params.category_id == category.id|string else '' }}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button type="submit" id="filterBtn" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors text-sm font-medium">
                    筛选
                </button>
                <button type="button" id="resetBtn" class="px-4 py-2 text-gray-600 hover:text-primary transition-colors text-sm">
                    重置
                </button>
            </div>
            <div class="text-sm text-gray-600">
                共找到 <span class="font-medium text-primary">{{ transactions.total }}</span> 条记录
            </div>
        </div>
    </form>
</div>

<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6">
        {% if transactions.items %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            {% if current_user.role != 'employee' %}
                            <th class="text-left py-3 px-4 font-medium text-gray-700">
                                <input type="checkbox" id="selectAll" class="rounded text-primary focus:ring-primary/20">
                            </th>
                            {% endif %}
                            <th class="text-left py-3 px-4 font-medium text-gray-700">日期</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">类型</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">分类</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">金额</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">备注说明</th>

                            {% if current_user.role != 'employee' %}
                            <th class="text-left py-3 px-4 font-medium text-gray-700">操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions.items %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                            {% if current_user.role != 'employee' %}
                            <td class="py-3 px-4">
                                <input type="checkbox" class="transaction-checkbox rounded text-primary focus:ring-primary/20" data-id="{{ transaction.id }}">
                            </td>
                            {% endif %}
                            <td class="py-3 px-4 text-gray-900">{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if transaction.type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ '收入' if transaction.type == 'income' else '支出' }}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-gray-700">{{ transaction.category.name }}</td>
                            <td class="py-3 px-4 text-right font-medium {% if transaction.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ '+' if transaction.type == 'income' else '-' }}¥{{ "%.2f"|format(transaction.amount) }}
                            </td>
                            <td class="py-3 px-4 text-gray-700">
                                {{ transaction.description or '-' }}
                            </td>

                            {% if current_user.role != 'employee' %}
                            <td class="py-3 px-4">
                                <div class="flex items-center space-x-2">
                                    <button onclick="openEditModal({{ transaction.id }}, '{{ transaction.date.strftime('%Y-%m-%d') }}', {{ (transaction.description or '')|tojson }}, '{{ transaction.type }}', {{ transaction.category.id if transaction.category else 'null' }}, {{ "%.2f"|format(transaction.amount) }}, {{ transaction.supplier.id if transaction.supplier else 'null' }}, {{ transaction.product.id if transaction.product else 'null' }}, {{ transaction.quantity if transaction.quantity else 'null' }}, {{ "%.2f"|format(transaction.unit_price) if transaction.unit_price else 'null' }})" 
                                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary transition-colors" 
                                            title="编辑">
                                        <div class="w-4 h-4 flex items-center justify-center">
                                            <i class="ri-edit-line"></i>
                                        </div>
                                    </button>
                                    <button onclick="deleteTransaction({{ transaction.id }})" 
                                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors" 
                                            title="删除">
                                        <div class="w-4 h-4 flex items-center justify-center">
                                            <i class="ri-delete-bin-line"></i>
                                        </div>
                                    </button>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页和批量操作 -->
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    {% if current_user.role != 'employee' %}
                    <div class="text-sm text-gray-600" id="selectedCount">已选择 0 项</div>
                    <button class="text-sm text-red-600 hover:text-red-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed" 
                            id="batchDeleteBtn" disabled onclick="batchDeleteTransactions()">批量删除</button>
                    {% endif %}
                    {% if transactions.pages > 1 %}
                    <div class="text-sm text-gray-600">显示 {{ (transactions.page - 1) * transactions.per_page + 1 }}-{{ transactions.page * transactions.per_page if transactions.page * transactions.per_page < transactions.total else transactions.total }} 条，共 {{ transactions.total }} 条记录</div>
                    {% endif %}
                </div>
                {% if transactions.pages > 1 %}
                <div class="flex items-center space-x-2">
                    {% if transactions.has_prev %}
                        <a href="{{ url_for('transactions', page=transactions.prev_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            上一页
                        </a>
                    {% endif %}
                    
                    {% for page_num in transactions.iter_pages() %}
                        {% if page_num %}
                            <a href="{{ url_for('transactions', page=page_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                               class="px-3 py-2 text-sm {% if page_num == transactions.page %}bg-primary text-white rounded-xl{% else %}text-gray-600 hover:text-primary transition-colors{% endif %}">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="px-3 py-2 text-sm text-gray-400">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if transactions.has_next %}
                        <a href="{{ url_for('transactions', page=transactions.next_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            下一页
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-inbox text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">暂无交易记录</h3>
                <p class="text-gray-600 mb-8">开始记录您的第一笔交易，建立完整的财务档案</p>
                {% if current_user.role != 'employee' %}
                <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors flex items-center justify-center mx-auto w-fit font-medium">
                    <i class="fas fa-plus mr-2"></i>添加第一笔交易
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- 编辑交易模态框 -->
<div id="editTransactionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-4xl mx-4 shadow-2xl border border-white/20 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">编辑交易记录</h3>
            <button id="closeEditModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="ri-close-line text-gray-600"></i>
            </button>
        </div>
        <form id="editTransactionForm" class="space-y-6">
            <input type="hidden" id="editTransactionId">
            
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">基本信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">交易金额 <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                            <input type="number" id="editAmount" required step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">交易类型 <span class="text-red-500">*</span></label>
                        <select id="editType" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="income">收入</option>
                            <option value="expense">支出</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">交易描述</label>
                        <input type="text" id="editDescription" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                        <select id="editCategory" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择分类</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">交易日期 <span class="text-red-500">*</span></label>
                        <input type="date" id="editDate" required class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">供应商</label>
                        <select id="editSupplier" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择供应商</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

            </div>
            
            <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">商品信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">商品</label>
                        <select id="editProduct" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                            <option value="">请选择商品</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">数量</label>
                        <input type="number" id="editQuantity" step="0.01" min="0" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">单价</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                            <input type="number" id="editUnitPrice" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" id="cancelEditBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存修改</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 筛选功能
    const filterForm = document.getElementById('filterForm');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    // 重置筛选
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // 清空所有筛选字段
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            
            // 重新加载页面（不带筛选参数）
            window.location.href = window.location.pathname;
        });
    }
    
    // 导出功能
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            // 获取当前筛选参数
            const params = new URLSearchParams(window.location.search);
            params.set('export', 'true');
            
            // 这里可以添加导出功能的实现
            alert('导出功能开发中...');
        });
    }
    
    // 移动端布局强制函数
    function forceMobileLayout() {
        if (window.innerWidth <= 768) {
            // 强制页面标题区域为垂直布局
            const titleAreas = document.querySelectorAll('.flex.items-center.justify-between.mb-8');
            titleAreas.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.alignItems = 'flex-start';
                element.style.gap = '1rem';
            });
            
            // 强制筛选区域为单列布局
            const gridElements = document.querySelectorAll('.grid.grid-cols-1.md\\:grid-cols-3');
            gridElements.forEach(function(element) {
                element.style.gridTemplateColumns = '1fr';
                element.style.gap = '1rem';
            });
            
            // 强制按钮组为垂直布局
            const buttonGroups = document.querySelectorAll('.flex.items-center.space-x-4');
            buttonGroups.forEach(function(element) {
                element.style.flexDirection = 'column';
                element.style.gap = '0.5rem';
                element.style.width = '100%';
            });
        }
    }
    
    // 移动端表格优化
    if (window.innerWidth < 768) {
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                // 在移动端点击行时显示详细信息
                const cells = this.querySelectorAll('td');
                if (cells.length > 0) {
                    // 根据用户角色调整单元格索引
                    const isEmployee = {{ 'true' if current_user.role == 'employee' else 'false' }};
                    const dateIndex = isEmployee ? 0 : 1;
                    const typeIndex = isEmployee ? 1 : 2;
                    const categoryIndex = isEmployee ? 2 : 3;
                    const amountIndex = isEmployee ? 3 : 4;
                    
                    const date = cells[dateIndex] ? cells[dateIndex].textContent.trim() : '';
                    const type = cells[typeIndex] ? cells[typeIndex].textContent.trim() : '';
                    const category = cells[categoryIndex] ? cells[categoryIndex].textContent.trim() : '';
                    const amount = cells[amountIndex] ? cells[amountIndex].textContent.trim() : '';
                    
                    if (window.MobileUtils) {
                        window.MobileUtils.showMobileHint(`${date}\n${type} - ${category}\n${amount}`, 2000);
                    }
                }
            });
        });
        
        // 执行移动端布局强制
        forceMobileLayout();
    }
    
    // 窗口大小变化时重新应用移动端布局
    window.addEventListener('resize', function() {
        setTimeout(forceMobileLayout, 100);
    });
    
    // 页面加载完成后执行
    setTimeout(forceMobileLayout, 500);
    
    // 初始化批量选择功能
    initBatchSelection();
    
    // 初始化编辑模态框
    initEditModal();
});

// 编辑模态框相关函数
function initEditModal() {
    const editModal = document.getElementById('editTransactionModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editForm = document.getElementById('editTransactionForm');
    const editProduct = document.getElementById('editProduct');
    const editQuantity = document.getElementById('editQuantity');
    const editUnitPrice = document.getElementById('editUnitPrice');
    const editAmount = document.getElementById('editAmount');
    
    // 关闭模态框
    closeEditModal.addEventListener('click', function() {
        editModal.classList.add('hidden');
    });
    
    cancelEditBtn.addEventListener('click', function() {
        editModal.classList.add('hidden');
    });
    
    // 点击模态框外部关闭
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
            editModal.classList.add('hidden');
        }
    });
    
    // 商品选择时自动填充单价
    editProduct.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.price) {
            editUnitPrice.value = selectedOption.dataset.price;
            calculateAmount();
        }
    });
    
    // 数量或单价变化时自动计算金额
    editQuantity.addEventListener('input', calculateAmount);
    editUnitPrice.addEventListener('input', calculateAmount);
    
    function calculateAmount() {
        const quantity = parseFloat(editQuantity.value) || 0;
        const unitPrice = parseFloat(editUnitPrice.value) || 0;
        if (quantity > 0 && unitPrice > 0) {
            editAmount.value = (quantity * unitPrice).toFixed(2);
        }
    }
    }
    
    // 表单提交
    editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('amount', document.getElementById('editAmount').value);
        formData.append('type', document.getElementById('editType').value);
        formData.append('description', document.getElementById('editDescription').value);
        formData.append('category_id', document.getElementById('editCategory').value);
        formData.append('date', document.getElementById('editDate').value);
        formData.append('supplier_id', document.getElementById('editSupplier').value);
        formData.append('product_id', document.getElementById('editProduct').value);
        formData.append('quantity', document.getElementById('editQuantity').value);
        formData.append('unit_price', document.getElementById('editUnitPrice').value);

        
        const transactionId = document.getElementById('editTransactionId').value;
        
        fetch(`/edit_transaction/${transactionId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                editModal.classList.add('hidden');
                location.reload(); // 刷新页面显示更新后的数据
            } else {
                alert('保存失败，请重试');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('保存失败，请重试');
        });
    });
}

// 打开编辑模态框
function openEditModal(id, date, description, type, categoryId, amount, supplierId, productId, quantity, unitPrice) {
    const editModal = document.getElementById('editTransactionModal');
    
    // 填充表单数据
    document.getElementById('editTransactionId').value = id;
    document.getElementById('editDate').value = date;
    document.getElementById('editDescription').value = description || '';
    document.getElementById('editType').value = type;
    document.getElementById('editCategory').value = categoryId || '';
    document.getElementById('editAmount').value = amount;
    document.getElementById('editSupplier').value = supplierId || '';
    document.getElementById('editProduct').value = productId || '';
    document.getElementById('editQuantity').value = quantity || '';
    document.getElementById('editUnitPrice').value = unitPrice || '';
    
    // 显示模态框
    editModal.classList.remove('hidden');
}

// 批量选择功能
function initBatchSelection() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const transactionCheckboxes = document.querySelectorAll('.transaction-checkbox');
    const selectedCountElement = document.getElementById('selectedCount');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    
    if (!selectAllCheckbox || !selectedCountElement || !batchDeleteBtn) return;
    
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
        const count = checkedBoxes.length;
        selectedCountElement.textContent = `已选择 ${count} 项`;
        batchDeleteBtn.disabled = count === 0;
        
        // 更新全选复选框状态
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === transactionCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        transactionCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectedCount();
    });
    
    // 单个复选框变化
    transactionCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

// 批量删除功能
function batchDeleteTransactions() {
    const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
    const transactionIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));
    
    if (transactionIds.length === 0) {
        alert('请选择要删除的交易记录');
        return;
    }
    
    if (confirm(`确定要删除选中的 ${transactionIds.length} 条交易记录吗？此操作不可撤销。`)) {
        // 逐个删除选中的交易记录
        let deletedCount = 0;
        const totalCount = transactionIds.length;
        
        transactionIds.forEach((id, index) => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete_transaction/${id}`;
            form.style.display = 'none';
            
            // 添加CSRF token（如果需要）
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            
            // 只在最后一个表单提交时刷新页面
            if (index === totalCount - 1) {
                form.submit();
            } else {
                // 对于其他表单，使用fetch异步提交
                const formData = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                }).then(() => {
                    deletedCount++;
                    if (deletedCount === totalCount - 1) {
                        // 所有异步删除完成后，提交最后一个表单刷新页面
                        const lastForm = document.createElement('form');
                        lastForm.method = 'POST';
                        lastForm.action = `/delete_transaction/${transactionIds[totalCount - 1]}`;
                        lastForm.style.display = 'none';
                        if (csrfToken) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = 'csrf_token';
                            csrfInput.value = csrfToken.getAttribute('content');
                            lastForm.appendChild(csrfInput);
                        }
                        document.body.appendChild(lastForm);
                        lastForm.submit();
                    }
                });
                document.body.removeChild(form);
            }
        });
    }
}

// 删除交易记录函数
function deleteTransaction(transactionId) {
    if (confirm('确定要删除这条交易记录吗？此操作不可撤销。')) {
        // 创建一个隐藏的表单来提交删除请求
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_transaction/${transactionId}`;
        form.style.display = 'none';
        
        // 添加CSRF token（如果需要）
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</div>
{% endblock %}