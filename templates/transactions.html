{% extends "base.html" %}

{% block title %}收支记录 - 七彩果坊{% endblock %}

{% block content %}

<!-- 页面标题 -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">收支记录</h1>
        <p class="text-gray-600">查看和管理所有交易记录</p>
    </div>
    <div class="flex items-center space-x-4">
        <button class="px-4 py-2 text-gray-600 hover:text-primary transition-colors flex items-center space-x-2" id="exportBtn">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-download"></i>
            </div>
            <span>导出</span>
        </button>
        {% if current_user.role != 'employee' %}
        <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors font-medium flex items-center space-x-2" id="addTransactionBtn">
            <div class="w-4 h-4 flex items-center justify-center">
                <i class="fas fa-plus"></i>
            </div>
            <span>添加收支</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- 筛选区域 -->
<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6 mb-6">
    <form id="filterForm" method="GET">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">日期范围</label>
                <div class="flex items-center space-x-2">
                    <input type="date" id="startDate" name="start_date" value="{{ filter_params.start_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <span class="text-gray-400">至</span>
                    <input type="date" id="endDate" name="end_date" value="{{ filter_params.end_date or '' }}" class="flex-1 px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">交易类型</label>
                <select id="typeFilter" name="type" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部类型</option>
                    <option value="income" {{ 'selected' if filter_params.type == 'income' else '' }}>收入</option>
                    <option value="expense" {{ 'selected' if filter_params.type == 'expense' else '' }}>支出</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                <select id="categoryFilter" name="category_id" class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm">
                    <option value="">全部分类</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {{ 'selected' if filter_params.category_id == category.id|string else '' }}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button type="submit" id="filterBtn" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors text-sm font-medium">
                    筛选
                </button>
                <button type="button" id="resetBtn" class="px-4 py-2 text-gray-600 hover:text-primary transition-colors text-sm">
                    重置
                </button>
            </div>
            <div class="text-sm text-gray-600">
                共找到 <span class="font-medium text-primary">{{ transactions.total }}</span> 条记录
            </div>
        </div>
    </form>
</div>

<div class="bg-white/60 backdrop-blur-lg rounded-2xl shadow-lg border border-white/20 p-6">
        {% if transactions.items %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-medium text-gray-700">日期</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">类型</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">分类</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">交易对象</th>
                            <th class="text-right py-3 px-4 font-medium text-gray-700">金额</th>
                            <th class="text-left py-3 px-4 font-medium text-gray-700">支付方式</th>
                            {% if current_user.role != 'employee' %}
                            <th class="text-left py-3 px-4 font-medium text-gray-700">操作</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions.items %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                            <td class="py-3 px-4 text-gray-900">{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                            <td class="py-3 px-4">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if transaction.type == 'income' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ '收入' if transaction.type == 'income' else '支出' }}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-gray-700">{{ transaction.category.name }}</td>
                            <td class="py-3 px-4 text-gray-700">
                                {% if transaction.supplier %}
                                    {{ transaction.supplier.name }}
                                {% elif transaction.description %}
                                    {{ transaction.description }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-right font-medium {% if transaction.type == 'income' %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ '+' if transaction.type == 'income' else '-' }}¥{{ "%.2f"|format(transaction.amount) }}
                            </td>
                            <td class="py-3 px-4 text-gray-700">
                                {% if transaction.payment_method %}
                                    {{ transaction.payment_method }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            {% if current_user.role != 'employee' %}
                            <td class="py-3 px-4">
                                <button class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary transition-colors">
                                    <div class="w-4 h-4 flex items-center justify-center">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </div>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            {% if transactions.pages > 1 %}
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-600">显示 {{ (transactions.page - 1) * transactions.per_page + 1 }}-{{ transactions.page * transactions.per_page if transactions.page * transactions.per_page < transactions.total else transactions.total }} 条，共 {{ transactions.total }} 条记录</div>
                <div class="flex items-center space-x-2">
                    {% if transactions.has_prev %}
                        <a href="{{ url_for('transactions', page=transactions.prev_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            上一页
                        </a>
                    {% endif %}
                    
                    {% for page_num in transactions.iter_pages() %}
                        {% if page_num %}
                            <a href="{{ url_for('transactions', page=page_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                               class="px-3 py-2 text-sm {% if page_num == transactions.page %}bg-primary text-white rounded-xl{% else %}text-gray-600 hover:text-primary transition-colors{% endif %}">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="px-3 py-2 text-sm text-gray-400">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if transactions.has_next %}
                        <a href="{{ url_for('transactions', page=transactions.next_num, start_date=filter_params.start_date, end_date=filter_params.end_date, type=filter_params.type, category_id=filter_params.category_id) }}" 
                           class="px-3 py-2 text-sm text-gray-600 hover:text-primary transition-colors">
                            下一页
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-inbox text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">暂无交易记录</h3>
                <p class="text-gray-600 mb-8">开始记录您的第一笔交易，建立完整的财务档案</p>
                {% if current_user.role != 'employee' %}
                <a href="{{ url_for('add_transaction') }}" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors flex items-center justify-center mx-auto w-fit font-medium">
                    <i class="fas fa-plus mr-2"></i>添加第一笔交易
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 筛选功能
    const filterForm = document.getElementById('filterForm');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    // 重置筛选
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // 清空所有筛选字段
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            
            // 重新加载页面（不带筛选参数）
            window.location.href = window.location.pathname;
        });
    }
    
    // 导出功能
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            // 获取当前筛选参数
            const params = new URLSearchParams(window.location.search);
            params.set('export', 'true');
            
            // 这里可以添加导出功能的实现
            alert('导出功能开发中...');
        });
    }
    
    // 移动端表格优化
    if (window.innerWidth < 768) {
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                // 在移动端点击行时显示详细信息
                const cells = this.querySelectorAll('td');
                if (cells.length > 0) {
                    const date = cells[0].textContent.trim();
                    const type = cells[1].textContent.trim();
                    const category = cells[2].textContent.trim();
                    const amount = cells[4].textContent.trim();
                    
                    if (window.MobileUtils) {
                        window.MobileUtils.showMobileHint(`${date}\n${type} - ${category}\n${amount}`, 2000);
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}