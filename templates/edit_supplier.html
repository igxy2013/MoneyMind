{% extends "base.html" %}

{% block title %}编辑供应商 - 七彩果坊{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-3">
            <i class="fas fa-edit me-2"></i>编辑供应商
        </h2>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">供应商名称 *</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ supplier.name }}" placeholder="请输入供应商名称" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contact_person" class="form-label">联系人</label>
                        <input type="text" class="form-control" id="contact_person" name="contact_person" 
                               value="{{ supplier.contact_person or '' }}" placeholder="请输入联系人姓名">
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone" class="form-label">联系电话</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               value="{{ supplier.phone or '' }}" placeholder="请输入联系电话">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="supply_method" class="form-label">供应方式</label>
                                <select class="form-select" id="supply_method" name="supply_method">
                                    <option value="">请选择供应方式</option>
                                    <option value="产地直供/合作社" {% if supplier.supply_method == '产地直供/合作社' %}selected{% endif %}>产地直供/合作社</option>
                                    <option value="本地批发市场供应商" {% if supplier.supply_method == '本地批发市场供应商' %}selected{% endif %}>本地批发市场供应商</option>
                                    <option value="一件代发供应商" {% if supplier.supply_method == '一件代发供应商' %}selected{% endif %}>一件代发供应商</option>
                                    <option value="社区本地农户/小农场" {% if supplier.supply_method == '社区本地农户/小农场' %}selected{% endif %}>社区本地农户/小农场</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="importance_level" class="form-label">重要程度</label>
                                <select class="form-select" id="importance_level" name="importance_level">
                                    <option value="">请选择重要程度</option>
                                    <option value="核心供应商" {% if supplier.importance_level == '核心供应商' %}selected{% endif %}>核心供应商</option>
                                    <option value="备用供应商" {% if supplier.importance_level == '备用供应商' %}selected{% endif %}>备用供应商</option>
                                    <option value="临时供应商" {% if supplier.importance_level == '临时供应商' %}selected{% endif %}>临时供应商</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="supply_categories" class="form-label">供货品类</label>
                        <div id="categories-container">
                            {% for category in supplier.supply_categories_list %}
                            <div class="input-group mb-2">
                                <select class="form-select" name="supply_categories">
                                    <option value="">请选择商品</option>
                                    <option value="{{ category.product_name }}" selected>{{ category.product_name }}</option>
                                </select>
                                <button type="button" class="btn btn-outline-danger" onclick="removeCategory(this)">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                            {% endfor %}
                            <div class="input-group mb-2">
                                <select class="form-select" name="supply_categories">
                                    <option value="">请选择商品</option>
                                </select>
                                <button type="button" class="btn btn-outline-success" onclick="addCategory()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">从商品管理中选择该供应商供应的商品</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">供应商场地照片</label>
                        {% if supplier.images %}
                        <div class="mb-2">
                            <div class="row">
                                {% for image in supplier.images %}
                                <div class="col-md-4 mb-2">
                                    <div class="position-relative">
                                        <img src="{{ url_for('static', filename=image.image_path) }}" 
                                             alt="供应商图片" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
                                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                                                onclick="deleteImage({{ image.id }}, {{ supplier.id }})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <input type="file" class="form-control" id="images" name="images" 
                               accept="image/*" multiple>
                        <small class="form-text text-muted">支持 JPG、PNG、GIF、WEBP 格式，最大 16MB，可多选</small>
                        <div id="image-preview" class="mt-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">地址</label>
                        <textarea class="form-control" id="address" name="address" rows="3" 
                                  placeholder="请输入详细地址">{{ supplier.address or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                   {% if supplier.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                启用供应商
                            </label>
                        </div>
                        <small class="form-text text-muted">取消勾选将停用该供应商</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>保存修改
                        </button>
                        <a href="{{ url_for('suppliers') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>返回
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 加载商品列表
async function loadProducts() {
    try {
        const response = await fetch('/api/products', {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const products = await response.json();
        
        const selects = document.querySelectorAll('select[name="supply_categories"]');
        selects.forEach(select => {
            // 保留第一个选项和已选中的选项
            const selectedValue = select.value;
            select.innerHTML = '<option value="">请选择商品</option>';
            
            // 添加商品选项
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                if (product === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('加载商品列表失败:', error);
        // 如果是认证错误，重定向到登录页面
        if (error.message && error.message.includes('401')) {
            window.location.href = '/login';
        }
    }
}

// 添加品类选择框
function addCategory() {
    const container = document.getElementById('categories-container');
    const newGroup = document.createElement('div');
    newGroup.className = 'input-group mb-2';
    newGroup.innerHTML = `
        <select class="form-select" name="supply_categories">
            <option value="">请选择商品</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeCategory(this)">
            <i class="fas fa-minus"></i>
        </button>
    `;
    container.appendChild(newGroup);
    
    // 为新添加的选择框加载商品列表
    const newSelect = newGroup.querySelector('select');
    loadProductsForSelect(newSelect);
}

// 移除品类选择框
function removeCategory(button) {
    button.closest('.input-group').remove();
}

// 为指定选择框加载商品列表
async function loadProductsForSelect(select) {
    try {
        const response = await fetch('/api/products', {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const products = await response.json();
        
        select.innerHTML = '<option value="">请选择商品</option>';
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product;
            option.textContent = product;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('加载商品列表失败:', error);
        // 如果是认证错误，重定向到登录页面
        if (error.message && error.message.includes('401')) {
            window.location.href = '/login';
        }
    }
}

// 删除图片
async function deleteImage(imageId, supplierId) {
    if (!confirm('确定要删除这张图片吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/supplier/${supplierId}/images/${imageId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 刷新页面以更新图片显示
            location.reload();
        } else {
            alert('删除图片失败');
        }
    } catch (error) {
        console.error('删除图片失败:', error);
        alert('删除图片失败');
    }
}

// 图片预览
document.getElementById('images').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    
    for (let file of e.target.files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-thumbnail me-2 mb-2';
                img.style.maxWidth = '150px';
                img.style.maxHeight = '150px';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }
});

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
});
</script>
{% endblock %} 