{% extends "base.html" %}

{% block title %}编辑供应商 - 七彩果坊经营管理系统{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/offline-upload.js') }}"></script>
{% endblock %}


{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-3">
            <i class="fas fa-edit me-2"></i>编辑供应商
        </h2>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-body p-4">
                <form id="editSupplierForm" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">供应商名称 *</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ supplier.name }}" placeholder="请输入供应商名称" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contact_person" class="form-label">联系人</label>
                        <input type="text" class="form-control" id="contact_person" name="contact_person" 
                               value="{{ supplier.contact_person or '' }}" placeholder="请输入联系人姓名">
                    </div>
                    
                    <div class="mb-3">
                        <label for="phone" class="form-label">联系电话</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               value="{{ supplier.phone or '' }}" placeholder="请输入联系电话">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="supply_method" class="form-label">供应方式</label>
                                <select class="form-select" id="supply_method" name="supply_method">
                                    <option value="">请选择供应方式</option>
                                    <option value="产地直供/合作社" {% if supplier.supply_method == '产地直供/合作社' %}selected{% endif %}>产地直供/合作社</option>
                                    <option value="本地批发市场供应商" {% if supplier.supply_method == '本地批发市场供应商' %}selected{% endif %}>本地批发市场供应商</option>
                                    <option value="一件代发供应商" {% if supplier.supply_method == '一件代发供应商' %}selected{% endif %}>一件代发供应商</option>
                                    <option value="社区本地农户/小农场" {% if supplier.supply_method == '社区本地农户/小农场' %}selected{% endif %}>社区本地农户/小农场</option>
                                </select>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">供应商场地照片</label>
                        {% if supplier.images %}
                        <div class="mb-2">
                            <div class="row">
                                {% for image in supplier.images %}
                                <div class="col-md-4 mb-2">
                                    <div class="position-relative">
                                        <img src="{{ url_for('static', filename=image.image_path) }}" 
                                             alt="供应商图片" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
                                        <button type="button" class="btn btn-danger position-absolute top-0 end-0 m-1 delete-image-btn" 
                                                onclick="deleteImage({{ image.id }}, {{ supplier.id }})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <!-- 移动端专用删除按钮 -->
                                        <div class="mobile-delete-btn d-md-none">
                                            <button type="button" class="btn btn-outline-danger btn-sm w-100 mt-2" 
                                                    onclick="deleteImage({{ image.id }}, {{ supplier.id }})">
                                                <i class="fas fa-trash-alt me-1"></i>移除图片
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <input type="file" class="form-control" id="images" name="images" 
                               accept="image/*" multiple>
                        <small class="form-text text-muted">支持 JPG、PNG、GIF、WEBP 格式，最大 16MB，可多选</small>
                        <div id="image-preview" class="mt-2"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">地址</label>
                        <textarea class="form-control" id="address" name="address" rows="3" 
                                  placeholder="请输入详细地址">{{ supplier.address or '' }}</textarea>
                    </div>
                    

                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>保存修改
                        </button>
                        <a href="{{ url_for('suppliers') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>返回
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* 移动端删除按钮优化 */
.delete-image-btn {
    min-width: 40px;
    min-height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    border: 3px solid white;
    background-color: #dc2626 !important;
    z-index: 10;
}

.delete-image-btn i {
    font-size: 16px;
    color: white !important;
}

.delete-image-btn:hover {
    background-color: #b91c1c !important;
    transform: scale(1.1);
}

/* 移动端删除按钮样式 */
.mobile-delete-btn .btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.mobile-delete-btn .btn:hover {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
}

.mobile-delete-btn .btn:active {
    transform: scale(0.98);
}

/* 移动端特殊优化 */
@media (max-width: 768px) {
    .delete-image-btn {
        min-width: 56px;
        min-height: 56px;
        margin: 4px !important;
        top: -8px !important;
        right: -8px !important;
    }
    
    .delete-image-btn i {
        font-size: 20px;
    }
    
    /* 图片容器在移动端的优化 */
    .position-relative {
        margin-bottom: 20px;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .position-relative img {
        border-radius: 12px;
    }
    
    /* 增加图片容器的内边距，为删除按钮留出空间 */
    .col-md-4 {
        padding: 8px;
    }
    
    .mobile-delete-btn {
        margin-top: 8px;
    }
}

/* 触摸设备优化 */
@media (hover: none) and (pointer: coarse) {
    .delete-image-btn {
        min-width: 60px;
        min-height: 60px;
        top: -10px !important;
        right: -10px !important;
    }
    
    .delete-image-btn:active {
        transform: scale(0.9);
        transition: transform 0.15s ease;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.6);
    }
    
    .delete-image-btn i {
        font-size: 22px;
    }
    
    .mobile-delete-btn .btn {
        padding: 12px;
        font-size: 16px;
    }
}
</style>

<script>
let selectedFiles = [];
const supplierId = {{ supplier.id }};

// 删除图片
async function deleteImage(imageId, supplierId) {
    if (!confirm('确定要删除这张图片吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/supplier/${supplierId}/images/${imageId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 刷新页面以更新图片显示
            location.reload();
        } else {
            alert('删除图片失败');
        }
    } catch (error) {
        console.error('删除图片失败:', error);
        alert('删除图片失败');
    }
}

// 图片预览
document.getElementById('images').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    selectedFiles = Array.from(e.target.files);
    
    for (let file of selectedFiles) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-thumbnail me-2 mb-2';
                img.style.maxWidth = '150px';
                img.style.maxHeight = '150px';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }
});

// 表单提交处理
document.getElementById('editSupplierForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('name', document.getElementById('name').value);
    formData.append('contact_person', document.getElementById('contact_person').value);
    formData.append('phone', document.getElementById('phone').value);
    formData.append('supply_method', document.getElementById('supply_method').value);
    formData.append('address', document.getElementById('address').value);
    
    try {
        // 先更新供应商基本信息
        const response = await fetch(`/edit_supplier/${supplierId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // 如果有新图片需要上传
            if (selectedFiles.length > 0) {
                if (window.offlineUploader) {
                    try {
                        const uploadResults = await window.offlineUploader.uploadImages(
                            selectedFiles, 
                            supplierId
                        );
                        
                        const savedToLocal = uploadResults.filter(r => r.saved && !r.uploaded);
                        if (savedToLocal.length > 0) {
                            alert(`供应商信息已更新！${savedToLocal.length} 个图片文件已保存到本地，将在网络恢复后自动上传`);
                        } else {
                            alert('供应商信息和图片已成功更新！');
                        }
                    } catch (error) {
                        console.error('图片上传处理失败:', error);
                        alert('供应商信息已更新，但图片上传失败，请稍后重试');
                    }
                } else {
                    // 降级到原有上传方式
                    const imageFormData = new FormData();
                    selectedFiles.forEach(file => {
                        imageFormData.append('images', file);
                    });
                    
                    const imageResponse = await fetch(`/api/supplier/${supplierId}/images`, {
                        method: 'POST',
                        body: imageFormData
                    });
                    
                    if (imageResponse.ok) {
                        alert('供应商信息和图片已成功更新！');
                    } else {
                        alert('供应商信息已更新，但图片上传失败，请稍后重试');
                    }
                }
            } else {
                alert('供应商信息已成功更新！');
            }
            
            // 跳转到供应商列表页面
            window.location.href = '/suppliers';
        } else {
            const errorText = await response.text();
            alert('更新失败：' + errorText);
        }
    } catch (error) {
        console.error('更新供应商时出错:', error);
        alert('更新供应商时出错，请重试');
    }
});

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化完成
});
</script>
{% endblock %}