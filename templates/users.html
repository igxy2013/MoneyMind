{% extends "base.html" %}

{% block title %}用户管理 - 七彩果坊经营管理系统{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/mobile.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Tailwind CSS 已在 base.html 中引用 -->
<link href="{{ url_for('static', filename='css/remixicon.min.css') }}" rel="stylesheet">

<div class="max-w-7xl mx-auto users-page">
    <!-- 页面标题 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">用户管理</h1>
        <p class="text-gray-600">管理系统用户，包括添加、编辑和分配角色等操作</p>
    </div>
    
    <!-- 操作区域 -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-4">
            <button id="addUserBtn" class="px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors flex items-center space-x-2">
                <div class="w-4 h-4 flex items-center justify-center">
                    <i class="ri-add-line"></i>
                </div>
                <span>添加用户</span>
            </button>
            <div class="relative">
                <select id="roleFilter" class="appearance-none bg-white/80 backdrop-blur-lg border border-white/20 rounded-button px-4 py-3 pr-10 text-gray-700 shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/20">
                    <option value="">全部角色</option>
                    <option value="admin">管理员</option>
                    <option value="manager">财务</option>
                    <option value="employee">普通用户</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <div class="w-4 h-4 flex items-center justify-center">
                        <i class="ri-arrow-down-s-line text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="relative">
            <input type="text" id="searchInput" placeholder="搜索用户名或邮箱" class="w-80 pl-10 pr-4 py-3 bg-white/80 backdrop-blur-lg border border-white/20 rounded-button text-gray-700 shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/20">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <div class="w-4 h-4 flex items-center justify-center">
                    <i class="ri-search-line text-gray-400"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户列表 -->
    <div class="bg-white/60 backdrop-blur-lg rounded-3xl shadow-lg border border-white/20 overflow-hidden">
        {% if users %}
            <!-- 桌面端表格 -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-white/40">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">用户信息</th>
                            <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">角色</th>
                            <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">状态</th>
                            <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">创建时间</th>
                            <th class="px-6 py-4 text-left text-sm font-medium text-gray-700">最后登录</th>
                            <th class="px-6 py-4 text-center text-sm font-medium text-gray-700">操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for user in users %}
                        <tr class="hover:bg-white/40 transition-colors user-row" data-role="{{ user.role }}" data-status="{{ '启用' if user.is_active else '禁用' }}">
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                        <span class="text-white font-medium text-sm">{{ user.username[0].upper() }}</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">{{ user.username }}</div>
                                        <div class="text-sm text-gray-500">{{ user.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                {% if user.role == 'admin' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">管理员</span>
                                {% elif user.role == 'manager' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">财务</span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">普通用户</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if user.is_active %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">启用</span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">禁用</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-gray-500 text-sm">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '未知' }}</td>
                            <td class="px-6 py-4 text-gray-500 text-sm">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '从未登录' }}</td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <button class="edit-btn w-8 h-8 bg-blue-100 hover:bg-blue-200 rounded-full flex items-center justify-center transition-colors" 
                                            data-id="{{ user.id }}" data-name="{{ user.username }}" data-email="{{ user.email }}" 
                                            data-role="{{ user.role }}" data-status="{{ '启用' if user.is_active else '禁用' }}">
                                        <i class="ri-edit-line text-blue-600 text-sm"></i>
                                    </button>
                                    <button class="role-btn w-8 h-8 bg-green-100 hover:bg-green-200 rounded-full flex items-center justify-center transition-colors" 
                                            data-id="{{ user.id }}" data-name="{{ user.username }}" data-role="{{ user.role }}">
                                        <i class="ri-shield-user-line text-green-600 text-sm"></i>
                                    </button>
                                    <button class="delete-btn w-8 h-8 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors" 
                                            data-id="{{ user.id }}" data-name="{{ user.username }}">
                                        <i class="ri-delete-bin-line text-red-600 text-sm"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 移动端卡片布局 -->
            <div class="mobile-users-list">
                {% for user in users %}
                <div class="user-mobile-card user-row" data-role="{{ user.role }}" data-status="{{ '启用' if user.is_active else '禁用' }}">
                    <div class="user-card-header">
                        <div class="user-info">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="user-avatar w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-medium text-sm">{{ user.username[0].upper() }}</span>
                                </div>
                                <div>
                                    <div class="user-name text-gray-900">{{ user.username }}</div>
                                    <div class="user-email text-gray-500">{{ user.email }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="edit-btn w-8 h-8 bg-blue-100 hover:bg-blue-200 rounded-full flex items-center justify-center transition-colors" 
                                    data-id="{{ user.id }}" data-name="{{ user.username }}" data-email="{{ user.email }}" 
                                    data-role="{{ user.role }}" data-status="{{ '启用' if user.is_active else '禁用' }}">
                                <i class="ri-edit-line text-blue-600 text-sm"></i>
                            </button>
                            <button class="role-btn w-8 h-8 bg-green-100 hover:bg-green-200 rounded-full flex items-center justify-center transition-colors" 
                                    data-id="{{ user.id }}" data-name="{{ user.username }}" data-role="{{ user.role }}">
                                <i class="ri-shield-user-line text-green-600 text-sm"></i>
                            </button>
                            <button class="delete-btn w-8 h-8 bg-red-100 hover:bg-red-200 rounded-full flex items-center justify-center transition-colors" 
                                    data-id="{{ user.id }}" data-name="{{ user.username }}">
                                <i class="ri-delete-bin-line text-red-600 text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="user-detail-item">
                            <span class="user-detail-label">角色</span>
                            <span class="user-detail-value">
                                {% if user.role == 'admin' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">管理员</span>
                                {% elif user.role == 'manager' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">财务</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">普通用户</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="user-detail-item">
                            <span class="user-detail-label">状态</span>
                            <span class="user-detail-value">
                                {% if user.is_active %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">启用</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">禁用</span>
                                {% endif %}
                            </span>
                        </div>
                        <div class="user-detail-item">
                            <span class="user-detail-label">创建时间</span>
                            <span class="user-detail-value">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '未知' }}</span>
                        </div>
                        <div class="user-detail-item">
                            <span class="user-detail-label">最后登录</span>
                            <span class="user-detail-value">{{ user.last_login.strftime('%m-%d %H:%M') if user.last_login else '从未登录' }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-user-line text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">暂无用户</h3>
                <p class="text-gray-500 mb-6">添加您的第一个用户吧！</p>
                <button id="addUserBtn" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors">
                        <i class="ri-add-line mr-2"></i>
                        添加用户
                    </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- 添加/编辑用户模态框 -->
<div id="userModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md mx-4 shadow-2xl border border-white/20">
        <div class="flex items-center justify-between mb-6">
            <h3 id="userModalTitle" class="text-xl font-bold text-gray-900">添加用户</h3>
            <button id="closeUserModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="ri-close-line text-gray-600"></i>
            </button>
        </div>
        <form id="userForm" class="space-y-6">
            <input type="hidden" id="userId" name="user_id">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                <input type="text" id="userName" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="请输入用户名" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
                <input type="email" id="userEmail" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="请输入邮箱地址" required>
            </div>
            
            <div id="passwordField">
                <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                <input type="password" id="userPassword" class="w-full px-4 py-3 bg-white/80 border border-gray-200 rounded-button focus:outline-none focus:ring-2 focus:ring-primary/20 text-gray-900" placeholder="请输入密码">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">角色</label>
                <div class="flex flex-col space-y-3">
                    <label class="flex items-center">
                        <input type="radio" name="userRole" value="admin" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">管理员</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="userRole" value="manager" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">财务</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="userRole" value="employee" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">普通用户</span>
                    </label>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="userStatus" value="启用" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">启用</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="userStatus" value="禁用" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">禁用</span>
                    </label>
                </div>
            </div>
            
            <div class="flex space-x-4 pt-4">
                <button type="button" id="cancelUserBtn" class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                <button type="submit" class="flex-1 px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 角色管理模态框 -->
<div id="roleModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md mx-4 shadow-2xl border border-white/20">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">角色管理</h3>
            <button id="closeRoleModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="ri-close-line text-gray-600"></i>
            </button>
        </div>
        <div class="mb-6">
            <p class="text-gray-600">用户：<span id="roleUserName" class="font-medium text-gray-900"></span></p>
            <p class="text-gray-600">当前角色：<span id="currentRole" class="font-medium text-gray-900"></span></p>
        </div>
        <form id="roleForm" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">选择新角色</label>
                <div class="flex flex-col space-y-3">
                    <label class="flex items-center">
                        <input type="radio" name="newRole" value="admin" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">管理员</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="newRole" value="manager" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">财务</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="newRole" value="employee" class="sr-only">
                        <div class="radio-custom w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center cursor-pointer">
                            <div class="radio-dot w-2 h-2 bg-primary rounded-full hidden"></div>
                        </div>
                        <span class="ml-2 text-gray-700">普通用户</span>
                    </label>
                </div>
            </div>
            <div class="flex space-x-4 pt-4">
                <button type="button" id="cancelRoleBtn" class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
                <button type="submit" class="flex-1 px-6 py-3 bg-primary text-white rounded-button whitespace-nowrap hover:bg-primary/90 transition-colors">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 删除确认模态框 -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white/90 backdrop-blur-lg rounded-3xl p-8 w-full max-w-md mx-4 shadow-2xl border border-white/20">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">确认删除</h3>
            <button id="closeDeleteModal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="ri-close-line text-gray-600"></i>
            </button>
        </div>
        <div class="mb-6">
            <p class="text-gray-700">您确定要删除用户 <span id="deleteUserName" class="font-semibold"></span> 吗？</p>
            <p class="text-sm text-gray-500 mt-2">此操作无法撤销。</p>
        </div>
        <div class="flex space-x-4">
            <button id="cancelDeleteBtn" class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-button whitespace-nowrap hover:bg-gray-200 transition-colors">取消</button>
            <button id="confirmDeleteBtn" class="flex-1 px-6 py-3 bg-red-500 text-white rounded-button whitespace-nowrap hover:bg-red-600 transition-colors">删除</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleFilter = document.getElementById('roleFilter');
    const searchInput = document.getElementById('searchInput');
    
    // 获取统一用户模态框元素
    const userModal = document.getElementById('userModal');
    const userForm = document.getElementById('userForm');
    const userModalTitle = document.getElementById('userModalTitle');
    const closeUserModal = document.getElementById('closeUserModal');
    const cancelUserBtn = document.getElementById('cancelUserBtn');
    const addUserBtn = document.getElementById('addUserBtn');
    
    // 获取角色管理模态框元素
    const roleModal = document.getElementById('roleModal');
    const roleForm = document.getElementById('roleForm');
    const closeRoleModal = document.getElementById('closeRoleModal');
    const cancelRoleBtn = document.getElementById('cancelRoleBtn');
    
    // 获取删除确认模态框元素
    const deleteModal = document.getElementById('deleteModal');
    const closeDeleteModal = document.getElementById('closeDeleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteUserName = document.getElementById('deleteUserName');
    
    let isEditMode = false;
    let deleteUserId = null;
    
    // 单选按钮功能
    function initRadioButtons() {
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // 清除同组其他选项的选中状态
                document.querySelectorAll(`input[name="${this.name}"]`).forEach(r => {
                    r.closest('label').querySelector('.radio-dot').classList.add('hidden');
                    r.closest('label').querySelector('.radio-custom').classList.remove('border-primary');
                });
                
                // 设置当前选项为选中状态
                if (this.checked) {
                    this.closest('label').querySelector('.radio-dot').classList.remove('hidden');
                    this.closest('label').querySelector('.radio-custom').classList.add('border-primary');
                }
            });
        });
    }
    
    function filterUsers() {
        const selectedRole = roleFilter.value;
        const searchTerm = searchInput.value.toLowerCase();
        const userRows = document.querySelectorAll('.user-row');
        
        userRows.forEach(row => {
            const rowRole = row.getAttribute('data-role');
            const userName = row.cells[0].querySelector('.font-medium').textContent.toLowerCase();
            const userEmail = row.cells[0].querySelector('.text-sm').textContent.toLowerCase();
            
            const roleMatch = selectedRole === '' || rowRole === selectedRole;
            const searchMatch = searchTerm === '' || userName.includes(searchTerm) || userEmail.includes(searchTerm);
            
            if (roleMatch && searchMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // 打开用户模态框（添加模式）
    function openAddUserModal() {
        isEditMode = false;
        userModalTitle.textContent = '添加用户';
        userForm.reset();
        document.getElementById('userId').value = '';
        document.getElementById('passwordField').querySelector('label').textContent = '密码';
        document.getElementById('userPassword').placeholder = '请输入密码';
        document.getElementById('userPassword').required = true;
        
        // 重置单选按钮状态
        document.querySelectorAll('#userModal .radio-dot').forEach(dot => dot.classList.add('hidden'));
        document.querySelectorAll('#userModal .radio-custom').forEach(custom => custom.classList.remove('border-primary'));
        userModal.classList.remove('hidden');
        initRadioButtons();
    }
    
    // 打开用户模态框（编辑模式）
    function openEditUserModal(userId, username, email, role, status) {
        isEditMode = true;
        userModalTitle.textContent = '编辑用户';
        
        document.getElementById('userId').value = userId;
        document.getElementById('userName').value = username;
        document.getElementById('userEmail').value = email;
        document.getElementById('userPassword').value = '';
        document.getElementById('passwordField').querySelector('label').textContent = '密码（留空则不修改）';
        document.getElementById('userPassword').placeholder = '留空则不修改密码';
        document.getElementById('userPassword').required = false;
        
        // 设置角色单选按钮
        document.querySelectorAll('input[name="userRole"]').forEach(radio => {
            radio.checked = radio.value === role;
            if (radio.checked) {
                radio.closest('label').querySelector('.radio-dot').classList.remove('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.add('border-primary');
            } else {
                radio.closest('label').querySelector('.radio-dot').classList.add('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.remove('border-primary');
            }
        });
        
        // 设置状态单选按钮
        document.querySelectorAll('input[name="userStatus"]').forEach(radio => {
            radio.checked = radio.value === status;
            if (radio.checked) {
                radio.closest('label').querySelector('.radio-dot').classList.remove('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.add('border-primary');
            } else {
                radio.closest('label').querySelector('.radio-dot').classList.add('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.remove('border-primary');
            }
        });
        
        userModal.classList.remove('hidden');
        initRadioButtons();
    }
    
    // 关闭用户模态框
    function closeUserModalFunc() {
        userModal.classList.add('hidden');
        userForm.reset();
        isEditMode = false;
    }
    
    // 打开角色管理模态框
    function openRoleModal(userId, username, role) {
        document.getElementById('roleUserName').textContent = username;
        document.getElementById('currentRole').textContent = getRoleText(role);
        
        // 设置当前角色为选中状态
        document.querySelectorAll('input[name="newRole"]').forEach(radio => {
            radio.checked = radio.value === role;
            if (radio.checked) {
                radio.closest('label').querySelector('.radio-dot').classList.remove('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.add('border-primary');
            } else {
                radio.closest('label').querySelector('.radio-dot').classList.add('hidden');
                radio.closest('label').querySelector('.radio-custom').classList.remove('border-primary');
            }
        });
        
        // 存储用户ID用于提交
        roleForm.dataset.userId = userId;
        
        roleModal.classList.remove('hidden');
        initRadioButtons();
    }
    
    // 关闭角色管理模态框
    function closeRoleModalFunc() {
        roleModal.classList.add('hidden');
        roleForm.reset();
    }
    
    // 打开删除确认模态框
    function openDeleteModal(userId, username) {
        deleteUserId = userId;
        deleteUserName.textContent = username;
        deleteModal.classList.remove('hidden');
    }
    
    // 关闭删除确认模态框
    function closeDeleteModalFunc() {
        deleteModal.classList.add('hidden');
        deleteUserId = null;
    }
    
    // 获取角色文本
    function getRoleText(role) {
        switch(role) {
            case 'admin': return '管理员';
            case 'manager': return '财务';
            case 'employee': return '普通用户';
            default: return role;
        }
    }
    
    // 添加用户按钮点击事件
    document.querySelectorAll('#addUserBtn').forEach(btn => {
        btn.addEventListener('click', openAddUserModal);
    });
    
    // 关闭用户模态框事件
    closeUserModal.addEventListener('click', closeUserModalFunc);
    cancelUserBtn.addEventListener('click', closeUserModalFunc);
    
    // 点击用户模态框背景关闭
    userModal.addEventListener('click', function(e) {
        if (e.target === userModal) {
            closeUserModalFunc();
        }
    });
    
    // 用户表单提交事件
    userForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('username', document.getElementById('userName').value);
        formData.append('email', document.getElementById('userEmail').value);
        formData.append('password', document.getElementById('userPassword').value);
        formData.append('role', document.querySelector('input[name="userRole"]:checked').value);
        
        const statusValue = document.querySelector('input[name="userStatus"]:checked').value;
        formData.append('is_active', statusValue === '启用' ? '1' : '0');
        
        if (isEditMode) {
            const userId = document.getElementById('userId').value;
            formData.append('user_id', userId);
            
            fetch(`/edit_user/${userId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeUserModalFunc();
                    location.reload();
                } else {
                    alert('更新用户信息失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新用户信息时发生错误，请重试。');
            });
        } else {
            fetch('/add_user', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeUserModalFunc();
                    location.reload();
                } else {
                    alert(data.message || '添加用户失败，请重试。');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加用户时发生错误，请重试。');
            });
        }
    });
    
    // 编辑按钮点击事件
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-btn')) {
            const btn = e.target.closest('.edit-btn');
            const userId = btn.getAttribute('data-id');
            const username = btn.getAttribute('data-name');
            const email = btn.getAttribute('data-email');
            const role = btn.getAttribute('data-role');
            const status = btn.getAttribute('data-status');
            
            openEditUserModal(userId, username, email, role, status);
        }
        
        // 角色管理按钮点击事件
        if (e.target.closest('.role-btn')) {
            const btn = e.target.closest('.role-btn');
            const userId = btn.getAttribute('data-id');
            const username = btn.getAttribute('data-name');
            const role = btn.getAttribute('data-role');
            
            openRoleModal(userId, username, role);
        }
        
        // 删除按钮点击事件
        if (e.target.closest('.delete-btn')) {
            const btn = e.target.closest('.delete-btn');
            const userId = btn.getAttribute('data-id');
            const username = btn.getAttribute('data-name');
            
            openDeleteModal(userId, username);
        }
    });
    
    // 关闭角色管理模态框事件
    closeRoleModal.addEventListener('click', closeRoleModalFunc);
    cancelRoleBtn.addEventListener('click', closeRoleModalFunc);
    
    // 点击角色管理模态框背景关闭
    roleModal.addEventListener('click', function(e) {
        if (e.target === roleModal) {
            closeRoleModalFunc();
        }
    });
    
    // 角色管理表单提交事件
    roleForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = this.dataset.userId;
        const newRole = document.querySelector('input[name="newRole"]:checked').value;
        
        fetch('/change_user_role', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user_id: userId,
                new_role: newRole
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeRoleModalFunc();
                location.reload();
            } else {
                alert('修改角色失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('修改角色时发生错误');
        });
    });
    
    // 关闭删除确认模态框事件
    closeDeleteModal.addEventListener('click', closeDeleteModalFunc);
    cancelDeleteBtn.addEventListener('click', closeDeleteModalFunc);
    
    // 点击删除确认模态框背景关闭
    deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
            closeDeleteModalFunc();
        }
    });
    
    // 确认删除按钮点击事件
    confirmDeleteBtn.addEventListener('click', function() {
        if (deleteUserId) {
            fetch('/delete_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: deleteUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModalFunc();
                    location.reload();
                } else {
                    alert('删除用户失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除用户时发生错误');
            });
        }
    });
    
    roleFilter.addEventListener('change', filterUsers);
    searchInput.addEventListener('input', filterUsers);
    
    // 初始化单选按钮
    initRadioButtons();
});
</script>
{% endblock %}