# 用户权限管理系统

## 权限级别

### 1. 管理员 (admin)
- **完整权限**：拥有系统的所有权限
- **用户管理**：可以添加、编辑、删除用户
- **数据管理**：可以查看和编辑所有数据
- **系统管理**：可以管理分类、供应商、商品、交易记录、应收款

### 2. 经理 (manager)
- **数据管理**：可以查看和编辑所有数据
- **业务管理**：可以管理分类、供应商、商品、交易记录、应收款
- **限制**：不能管理用户（用户管理仅限管理员）

### 3. 员工 (employee)
- **只读权限**：只能查看数据，不能编辑任何记录
- **查看功能**：
  - 仪表板统计信息
  - 交易记录列表
  - 分类管理页面
  - 供应商管理页面
  - 商品管理页面
  - 统计分析页面
  - 应收款管理页面
- **限制**：
  - 看不到添加/编辑/删除按钮
  - 无法访问编辑功能的路由
  - 侧边栏不显示"添加交易"链接
  - 仪表板不显示"添加交易"按钮
  - 统计分析页面不显示"添加交易"按钮

## 权限控制实现

### 后端权限控制
1. **装饰器控制**：
   - `@admin_required`：仅管理员和经理可访问
   - `@edit_required`：仅管理员和经理可编辑
   - `@login_required`：所有登录用户可访问

2. **路由权限**：
   - 查看功能：所有用户可访问
   - 编辑功能：仅管理员和经理可访问
   - 用户管理：仅管理员可访问

### 前端权限控制
1. **按钮显示**：
   - 员工用户看不到编辑按钮
   - 员工用户看不到添加按钮
   - 员工用户看不到删除按钮
   - 员工用户看不到仪表板中的"添加交易"按钮
   - 员工用户看不到统计分析页面中的"添加交易"按钮

2. **导航菜单**：
   - 员工用户看不到"添加交易"链接
   - 员工用户看不到管理功能区域

3. **表格列**：
   - 员工用户看不到"操作"列

4. **仪表板功能**：
   - 员工用户看不到快速操作中的添加按钮
   - 员工用户看不到最近交易卡片中的"添加交易"按钮
   - 员工用户看不到"暂无交易记录"时的"添加第一笔交易"按钮

## 测试账户

### 默认账户
- **管理员**：admin / admin123
- **测试员工**：test_employee / 123456
- **测试经理**：test_manager / 123456

### 测试步骤
1. 使用员工账户登录
2. 验证只能查看数据，不能编辑
3. 验证页面上没有编辑按钮
4. 验证侧边栏没有添加交易链接
5. 验证仪表板没有添加交易按钮
6. 验证统计分析页面没有添加交易按钮
7. 尝试直接访问编辑页面，应该显示权限不足提示

## 安全特性

1. **双重保护**：
   - 前端隐藏编辑按钮
   - 后端验证权限装饰器

2. **友好提示**：
   - 权限不足时显示中文提示
   - 自动重定向到仪表板

3. **角色标识**：
   - 侧边栏显示用户角色
   - 不同角色使用不同图标

## 权限矩阵

| 功能 | 管理员 | 经理 | 员工 |
|------|--------|------|------|
| 查看仪表板 | ✅ | ✅ | ✅ |
| 查看交易记录 | ✅ | ✅ | ✅ |
| 添加交易记录 | ✅ | ✅ | ❌ |
| 编辑交易记录 | ✅ | ✅ | ❌ |
| 删除交易记录 | ✅ | ✅ | ❌ |
| 查看分类管理 | ✅ | ✅ | ✅ |
| 编辑分类 | ✅ | ✅ | ❌ |
| 查看供应商管理 | ✅ | ✅ | ✅ |
| 编辑供应商 | ✅ | ✅ | ❌ |
| 查看商品管理 | ✅ | ✅ | ✅ |
| 编辑商品 | ✅ | ✅ | ❌ |
| 查看统计分析 | ✅ | ✅ | ✅ |
| 查看应收款 | ✅ | ✅ | ✅ |
| 编辑应收款 | ✅ | ✅ | ❌ |
| 用户管理 | ✅ | ❌ | ❌ |
| 仪表板添加按钮 | ✅ | ✅ | ❌ |
| 统计页面添加按钮 | ✅ | ✅ | ❌ |

## 技术实现

### 装饰器定义
```python
def edit_required(f):
    @wraps(f)
    @login_required
    def decorated_function(*args, **kwargs):
        if current_user.role == 'employee':
            flash('员工权限不足，只能查看数据', 'error')
            return redirect(url_for('dashboard'))
        return f(*args, **kwargs)
    return decorated_function
```

### 模板条件判断
```html
{% if current_user.role != 'employee' %}
    <!-- 编辑按钮 -->
{% endif %}
```

### 路由权限控制
```python
@app.route('/add_transaction', methods=['GET', 'POST'])
@edit_required
def add_transaction():
    # 仅管理员和经理可访问
```

## 维护说明

1. **添加新功能时**：
   - 确定是否需要权限控制
   - 选择合适的装饰器
   - 在模板中添加条件判断

2. **修改权限时**：
   - 更新装饰器逻辑
   - 更新模板条件
   - 更新文档说明

3. **测试权限时**：
   - 使用不同角色账户测试
   - 验证前端和后端权限一致
   - 检查错误提示是否友好

## 最新更新

### 2025-08-04 权限系统完善
- ✅ 仪表板页面权限控制
- ✅ 统计分析页面权限控制
- ✅ 快速操作按钮权限控制
- ✅ 最近交易卡片权限控制
- ✅ 暂无数据时的添加按钮权限控制 